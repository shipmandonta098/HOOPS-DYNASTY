<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOOPS DYNASTY</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.085);
      --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 10% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(167,139,250,.18), transparent 55%),
        radial-gradient(700px 600px at 40% 90%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .hide{display:none !important;}

    /* buttons / inputs */
    .btn{
      cursor:pointer;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 12px;border-radius:12px;
      transition:transform .06s ease, border-color .15s ease, background .15s ease;
      font-weight:700;font-size:13px;
    }
    .btn:hover{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.06);}
    .btn:active{transform:translateY(1px);}
    .btn.primary{border-color:rgba(110,231,255,.35);background:rgba(110,231,255,.10);}
    .btn.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10);}

    input, select{
      width:100%;
      padding:12px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:var(--text);outline:none;
    }

    .muted{color:var(--muted);font-size:12px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    /* cards */
    .card{
      background:linear-gradient(to bottom, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .title{
      font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);
    }
    .bd{padding:12px;}

    /* splash */
    .splash{
      position:fixed; inset:0;
      display:grid; place-items:center;
      background:
        radial-gradient(900px 450px at 50% 25%, rgba(110,231,255,.22), transparent 60%),
        radial-gradient(850px 550px at 50% 80%, rgba(167,139,250,.22), transparent 60%),
        var(--bg);
      z-index:50;
    }
    .splash-inner{ text-align:center; padding: 16px; }
    .splash-title{
      font-size:56px;
      font-weight:900;
      letter-spacing:.18em;
      margin:0;
      text-transform:uppercase;
    }
    .splash-sub{ margin: 12px 0 30px; color: rgba(255,255,255,.65); }
    .splash-btn{ width:min(520px, 92vw); padding:16px 18px; font-size:14px; }

    /* menus */
    .menu-wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 34px 16px;
      display:grid;
      gap: 14px;
    }

    /* app layout */
    .topbar{
      position:sticky; top:0; z-index:5;
      backdrop-filter:blur(10px);
      background:linear-gradient(to bottom, rgba(10,16,32,.82), rgba(10,16,32,.55));
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:1200px;margin:0 auto;padding:14px 16px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:conic-gradient(from 210deg, var(--accent), var(--accent2), var(--good), var(--accent));
      box-shadow:var(--shadow);
    }
    h1{font-size:14px;margin:0;letter-spacing:.4px;}
    .pills{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .pill{
      font-size:12px;padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(255,255,255,.04);color:var(--muted);
    }
    .wrap{
      max-width:1200px; margin: 0 auto; padding:16px;
      display:grid; grid-template-columns:320px 1fr; gap:14px;
    }
    @media (max-width:950px){ .wrap{grid-template-columns:1fr;} }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab{
      cursor:pointer;padding:9px 10px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-size:12px;font-weight:750;color:var(--muted);user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(110,231,255,.35);
      background:rgba(110,231,255,.10);
    }

    table{
      width:100%;border-collapse:collapse;
      overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.10);
    }
    th,td{
      padding:10px;border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;font-size:13px;
    }
    th{
      font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);
      background:rgba(255,255,255,.03);
    }
    tr:last-child td{border-bottom:0;}
    .right{text-align:right;}

    /* Team picker table */
    #teamPickTable tbody tr { cursor: pointer; }
    #teamPickTable tbody tr:hover { background: rgba(255,255,255,.05); }
    #teamPickTable tbody tr.selected { background: rgba(110,231,255,.08); }

    /* Market size chips */
    .market-Large { color:#6ee7ff; font-weight:600; }
    .market-Medium{ color:#a78bfa; }
    .market-Small { color:#9ca3af; }

    /* League manager table/actions */
    .actions{ display:flex; gap:8px; flex-wrap:wrap; }
    .actions .btn{ padding:8px 10px; font-size:12px; }
    .table-scroll{ max-height:360px; overflow:auto; }

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      font-size:11px;color:var(--muted);
      margin-left:8px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);box-shadow:0 0 0 3px rgba(110,231,255,.12);}

    .bar{
      height:8px;border-radius:999px;background:rgba(255,255,255,.10);
      overflow:hidden;border:1px solid rgba(255,255,255,.10);
    }
    .bar>i{
      display:block;height:100%;width:50%;
      background:linear-gradient(to right, var(--accent), var(--accent2));
    }

    .callout{
      padding:12px;border-radius:14px;
      border:1px solid rgba(110,231,255,.25);
      background:linear-gradient(to right, rgba(110,231,255,.12), rgba(167,139,250,.08));
    }

    .log{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;line-height:1.35;white-space:pre-wrap;
      color:rgba(255,255,255,.78);
    }

    .big{font-size:18px;font-weight:900;letter-spacing:.2px;}
    /* Sidebar / app-shell styles */
    .app-shell{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:14px;
    }

    @media (max-width:950px){
      .app-shell{ grid-template-columns:1fr; }
      .sidebar{ order: 1; }
      .main{ order: 2; }
    }

    .nav{ display:flex; flex-direction:column; gap:8px; }
    .nav-item{
      width:100%;
      text-align:left;
      cursor:pointer;
      padding:11px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--muted);
      font-weight:800;
      font-size:12px;
      display:flex;align-items:center;gap:12px;
    }
    .nav-item .ico{ width:22px;text-align:center;font-size:18px; }
    .nav-item:hover{ border-color:rgba(255,255,255,.22); background:rgba(255,255,255,.06); }
    .nav-item.active{
      color:var(--text);
      border-color:rgba(110,231,255,.35);
      background:rgba(110,231,255,.10);
    }
    /* Icon-only sidebar when collapsed: hide labels and center icons */
    .app-shell.is-collapsed .sidebar .nav-item .lbl{ display:none; }
    .app-shell.is-collapsed .sidebar .nav-item{ justify-content:center; padding:12px 0; }
    /* Collapsible sidebar styles */
    .app-shell{ transition: 200ms ease; }
    .app-shell.is-collapsed{ grid-template-columns: 72px 1fr; }
    .app-shell.is-collapsed .sidebar .title,
    .app-shell.is-collapsed .sidebar .muted,
    .app-shell.is-collapsed .sidebar .callout,
    .app-shell.is-collapsed .sidebar select,
    .app-shell.is-collapsed .sidebar .log,
    .app-shell.is-collapsed .sidebar .row{ display:none !important; }
    .app-shell.is-collapsed .nav-item{ text-align:center; padding:12px 0; font-size:12px; }
    @media (max-width:950px){
      .app-shell.is-collapsed{ grid-template-columns: 1fr; }
      .app-shell.is-collapsed .sidebar{ display:none; }
    }
    /* Modal styles (player modal) */
    .modal{ position:fixed; inset:0; z-index:999; }
    .modal.hide{ display:none; }

    .modal-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.55); }

    .modal-card{
      position:relative; max-width:720px; margin:60px auto;
      background: rgba(18,24,46,.96);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px; box-shadow: 0 30px 80px rgba(0,0,0,.45); overflow:hidden;
    }

    .modal-hd{ display:flex; justify-content:space-between; align-items:center; padding:14px 14px; border-bottom:1px solid rgba(255,255,255,.10); }
    .modal-title{ font-weight:900; font-size:18px; letter-spacing:.5px; }
    .modal-bd{ padding:14px; max-height:70vh; overflow:auto; }

    @media (max-width:820px){ .modal-card{ margin:10px; max-width:none; } }

    /* linklike for player names */
    .linklike{ all: unset; cursor: pointer; color: var(--text); }
    .linklike:hover{ text-decoration: underline; }
    /* Modal styles (player modal) */
    .modal{ position:fixed; inset:0; z-index:999; }
    .modal.hide{ display:none; }

    .modal-backdrop{ position:absolute; inset:0; background: rgba(0,0,0,.55); }

    .modal-card{
      position:relative; max-width:720px; margin:60px auto;
      background: rgba(18,24,46,.96); border:1px solid rgba(255,255,255,.12);
      border-radius:18px; box-shadow:0 30px 80px rgba(0,0,0,.45); overflow:hidden;
    }

    .modal-hd{ display:flex; justify-content:space-between; align-items:center; padding:14px 14px; border-bottom:1px solid rgba(255,255,255,.10); }
    .modal-title{ font-weight:900; font-size:18px; letter-spacing:.5px; }
    .modal-bd{ padding:14px; max-height:70vh; overflow:auto; }

    @media (max-width:820px){ .modal-card{ margin:10px; max-width:none; } }

    /* linklike player name style */
    .linklike{ all: unset; cursor: pointer; color: var(--text); }
    .linklike:hover{ text-decoration: underline; }
  </style>
</head>
<body>

<!-- 1) SPLASH -->
<div id="splashScreen" class="splash">
  <div class="splash-inner">
    <div class="logo" style="margin:0 auto 18px;" aria-hidden="true"></div>
    <div class="splash-title">HOOPS DYNASTY</div>
    <div class="splash-sub">Front office basketball simulation</div>
    <button class="btn primary splash-btn" id="btnEnterFO">Enter Front Office</button>
  </div>
</div>

<!-- 2) FRONT OFFICE MENU -->
<div id="frontOfficeScreen" class="menu-wrap hide">
  <div class="card">
    <div class="hd"><div class="title">Front Office</div></div>
    <div class="bd">
      <div class="row">
        <button class="btn primary" id="btnGoCreate">Create New League</button>
        <button class="btn" id="btnContinue">Continue</button>
        <button class="btn danger" id="btnWipeSave">Wipe Save</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        Continue lights up when a saved league exists.
      </div>
    </div>
  </div>
</div>

<!-- 2.5) LEAGUE MANAGER / CONTINUE -->
<div id="leagueManagerScreen" class="menu-wrap hide">
  <div class="card">
    <div class="hd">
      <div class="title">Continue</div>
      <div class="row">
        <label class="btn" for="importFile" style="display:inline-flex; align-items:center; gap:8px;">
          Import
        </label>
        <input id="importFile" type="file" accept="application/json" class="hide" />
        <button class="btn" id="btnBackFO2">Back</button>
      </div>
    </div>

    <div class="bd">
      <div class="muted" style="margin-bottom:10px;">
        Leagues saved on this device.
      </div>

      <div class="table-scroll">
        <table id="leagueTable">
          <thead>
            <tr>
              <th>League</th>
              <th style="width:110px;">Season</th>
              <th style="width:170px;">Last Played</th>
              <th style="width:340px;">Actions</th>
            </tr>
          </thead>
          <tbody id="leagueTableBody"></tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px;">
        Export = downloads a JSON file. Import = restores a league from JSON.
      </div>
    </div>
  </div>
</div>

<!-- 3) CREATE LEAGUE SCREEN -->
<div id="createLeagueScreen" class="menu-wrap hide">
  <div class="card">
    <div class="hd">
      <div class="title">Create League</div>
      <div class="muted" id="createHint">30 fictional teams ‚Ä¢ real U.S. cities</div>
    </div>
    <div class="bd">
      <div class="row">
        <div style="flex:1 1 320px;">
          <div class="muted">League Name</div>
          <div style="height:6px"></div>
          <input id="inpLeagueName" value="HOOPS DYNASTY" />
        </div>
        <div style="flex:1 1 220px;">
          <div class="muted">Season Year</div>
          <div style="height:6px"></div>
          <input id="inpSeasonYear" type="number" min="1900" max="2100" value="2026" />
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="muted">Select Your Team</div>
      <div style="height:10px"></div>

      <div class="card" style="box-shadow:none; background: rgba(255,255,255,.03);">
        <div class="bd" style="padding:0;">
          <table id="teamPickTable">
            <thead>
              <tr>
                <th style="width:50px;">#</th>
                <th style="width:70px;">Abbrev</th>
                <th>Team</th>
                <th style="width:90px;">Market</th>
                <th style="width:90px;">Conf</th>
                <th style="width:110px;">Division</th>
              </tr>
            </thead>
            <tbody id="teamPickBody"></tbody>
          </table>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        Selected: <strong id="pickedTeamLabel">‚Äî</strong>
      </div>

      <div style="height:14px"></div>

      <div class="row">
        <button class="btn" id="btnBackFO">Back</button>
        <button class="btn primary" id="btnCreateLeague">Create League</button>
      </div>
    </div>
  </div>
</div>

<!-- 4) APP -->
<div id="appScreen" class="hide">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="topTitle">HOOPS DYNASTY</h1>
          <div class="muted" id="topSub">‚Äî</div>
        </div>
      </div>
      <div class="pills">
        <span class="pill" id="pillSeason"></span>
        <span class="pill" id="pillDay"></span>
        <span class="pill" id="pillGamesLeft"></span>
      </div>
    </div>
  </div>

  <div class="app-shell">
    <!-- SIDEBAR -->
    <aside class="sidebar card">
      <div class="hd"><div class="title">Navigation</div></div>
      <div class="bd">
        <div class="nav">
          <button class="nav-item active" data-route="dashboard">
            <span class="ico">üè†</span>
            <span class="lbl">Team Dashboard</span>
          </button>
          <button class="nav-item" data-route="standings">
            <span class="ico">üìä</span>
            <span class="lbl">Standings</span>
          </button>
          <button class="nav-item" data-route="roster">
            <span class="ico">üë•</span>
            <span class="lbl">Roster</span>
          </button>
          <button class="nav-item" data-route="players">
            <span class="ico">üß†</span>
            <span class="lbl">Players</span>
          </button>
          <button class="nav-item" data-route="schedule">
            <span class="ico">üóìÔ∏è</span>
            <span class="lbl">Schedule</span>
          </button>
          <button class="nav-item" data-route="league">
            <span class="ico">üåê</span>
            <span class="lbl">League</span>
          </button>
          <button class="nav-item" data-route="settings">
            <span class="ico">‚öôÔ∏è</span>
            <span class="lbl">Settings</span>
          </button>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <button class="btn" id="btnHome">Front Office</button>
          <button class="btn primary" id="btnAdvanceDay">Advance Day</button>
          <button class="btn" id="btnSimGame">Sim Game</button>
        </div>

        <div style="height:12px"></div>

        <div class="muted">User Team</div>
        <div style="height:6px"></div>
        <select id="selUserTeam"></select>

        <div style="height:12px"></div>

        <div class="callout">
          <div class="muted">Next game</div>
          <div class="big" id="nextGameText">‚Äî</div>
          <div class="muted" id="nextGameSub">‚Äî</div>
        </div>

        <div style="height:12px"></div>

        <div class="card" style="box-shadow:none;">
          <div class="hd"><div class="title">Game Log</div></div>
          <div class="bd"><div id="log" class="log"></div></div>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main card">
      <div class="hd">
        <button class="btn" id="btnToggleSidebar" title="Toggle sidebar" style="padding:8px 10px;">‚ò∞</button>
        <div style="flex:1;">
          <div class="title" id="viewTitle">Team Dashboard</div>
          <div class="muted" id="viewHint"></div>
        </div>
      </div>
      <div class="bd" id="view"></div>
    </main>
  </div>
</div>

<script>
/** =========================================================
 *  30 fictional teams (real U.S. cities)
 *  ========================================================= */
const TEAMS_30 = [
  {abbrev:"NYC", city:"New York",       name:"Empire",   market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"LAX", city:"Los Angeles",    name:"Stars",    market:"Large", conference:"West", division:"Pacific"},
  {abbrev:"CHI", city:"Chicago",        name:"Forge",    market:"Large", conference:"East", division:"Central"},
  {abbrev:"HOU", city:"Houston",        name:"Comets",   market:"Large", conference:"West", division:"Southwest"},
  {abbrev:"PHI", city:"Philadelphia",   name:"Liberty",  market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"PHX", city:"Phoenix",        name:"Inferno",  market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"SAS", city:"San Antonio",    name:"Outlaws",  market:"Medium",conference:"West", division:"Southwest"},
  {abbrev:"SDG", city:"San Diego",      name:"Tide",     market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"DAL", city:"Dallas",         name:"Stampede", market:"Large", conference:"West", division:"Southwest"},
  {abbrev:"SJC", city:"San Jose",       name:"Quakes",   market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"ATX", city:"Austin",         name:"Riders",   market:"Small", conference:"West", division:"Southwest"},
  {abbrev:"JAX", city:"Jacksonville",   name:"Duval",    market:"Small", conference:"East", division:"Southeast"},
  {abbrev:"SFW", city:"San Francisco",  name:"Gold",     market:"Large", conference:"West", division:"Pacific"},
  {abbrev:"CLB", city:"Columbus",       name:"Capitals", market:"Small", conference:"East", division:"Central"},
  {abbrev:"CLT", city:"Charlotte",      name:"Crown",    market:"Medium",conference:"East", division:"Southeast"},
  {abbrev:"IND", city:"Indianapolis",   name:"Shock",    market:"Small", conference:"East", division:"Central"},
  {abbrev:"SEA", city:"Seattle",        name:"Frost",    market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"DEN", city:"Denver",         name:"Altitude", market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"WAS", city:"Washington",     name:"Sentinels",market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"BOS", city:"Boston",         name:"Harbor",   market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"DET", city:"Detroit",        name:"Motors",   market:"Medium",conference:"East", division:"Central"},
  {abbrev:"NSH", city:"Nashville",      name:"Sound",    market:"Medium",conference:"West", division:"Southwest"},
  {abbrev:"POR", city:"Portland",       name:"Pulse",    market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"OKC", city:"Oklahoma City",  name:"Storm",    market:"Small", conference:"West", division:"Northwest"},
  {abbrev:"LAS", city:"Las Vegas",      name:"Neon",     market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"MIA", city:"Miami",          name:"Vice",     market:"Large", conference:"East", division:"Southeast"},
  {abbrev:"MSP", city:"Minneapolis",    name:"North",    market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"BWI", city:"Baltimore",      name:"Brigade",  market:"Small", conference:"East", division:"Atlantic"},
  {abbrev:"SLT", city:"Salt Lake City", name:"Summit",   market:"Small", conference:"West", division:"Northwest"},
  {abbrev:"ORL", city:"Orlando",        name:"Magicline",market:"Medium",conference:"East", division:"Southeast"},
];

/** =========================================================
 *  Simple name generator (you can expand later)
 *  ========================================================= */
// Controlled name lists (men/women/mixed)
const FIRST_M = ["James","Michael","Chris","Darius","Jalen","Andre","Marcus","Devin","Trevor","Isaiah","Damian","Cameron","Jordan","Tariq","Malik"];
const FIRST_F = ["Aaliyah","Brianna","Kayla","Jasmine","Maya","Ava","Nia","Sofia","Tiana","Kiara","Naomi","Riley","Zoe","Imani","Jordan"];
const LAST = ["Carter","Johnson","Williams","Brown","Davis","Moore","Jackson","Taylor","Thomas","White","Harris","Martin","Thompson","Lee","Walker"];
const POS   = ["PG","SG","SF","PF","C"];

function rngInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

// Attribute generation helpers
function randn(){ // rough normal-ish distribution
  let u=0,v=0;
  while(u===0) u=Math.random();
  while(v===0) v=Math.random();
  return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v);
}
function around(mean, sd){
  return clamp(Math.round(mean + randn()*sd), 25, 95);
}

function archetypeForPos(pos){
  const A = {
    PG: {ins:55, mid:60, tp:62, ft:70, pass:78, handle:80, reb:45, def:55, iq:62, ath:60},
    SG: {ins:60, mid:66, tp:70, ft:75, pass:60, handle:65, reb:48, def:56, iq:60, ath:62},
    SF: {ins:64, mid:62, tp:62, ft:70, pass:58, handle:58, reb:60, def:60, iq:62, ath:64},
    PF: {ins:70, mid:58, tp:52, ft:65, pass:50, handle:45, reb:75, def:66, iq:62, ath:62},
    C:  {ins:75, mid:50, tp:35, ft:58, pass:45, handle:35, reb:82, def:72, iq:62, ath:58},
  };
  return A[pos] || A.SF;
}

function makeAttributes(pos, age){
  const base = archetypeForPos(pos);
  const sd = 10;

  const attr = {};
  for (const k of Object.keys(base)){
    attr[k] = around(base[k], sd);
  }

  const ageAdj = age <= 23 ? 2 : age >= 31 ? -2 : 0;
  for (const k of Object.keys(attr)){
    attr[k] = clamp(attr[k] + ageAdj, 25, 99);
  }

  return attr;
}

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

function makeName(){
  const set = state.nameSet || "Mixed";

  let first;
  if (set === "Men") first = pick(FIRST_M);
  else if (set === "Women") first = pick(FIRST_F);
  else { first = Math.random() < 0.5 ? pick(FIRST_M) : pick(FIRST_F); }

  const last = pick(LAST);
  return `${first} ${last}`;
}

function makePlayer(prefPos){
  const pos = prefPos || pick(POS);
  const age = rngInt(18, 34);
  const player = {
    id: (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : `${Date.now()}-${Math.floor(Math.random()*100000)}`,
    name: makeName(),
    pos,
    age,
    minutes: 0,
    role: "Rotation",
    history: [],
    ratings: makeAttributes(pos, age),
    traits: makeTraits(pos, age),
  };
  return player;
}

function makeTraits(pos, age){
  // Personality traits: competitiveness, discipline, workEthic, ego, chemistry, mental
  const base = 50;
  const sd = 12;
  const t = {
    competitiveness: clamp(Math.round(base + randn()*sd), 10, 99),
    discipline:      clamp(Math.round(base + randn()*sd), 10, 99),
    workEthic:       clamp(Math.round(base + randn()*sd), 10, 99),
    ego:             clamp(Math.round(base + randn()*sd), 10, 99),
    chemistry:       clamp(Math.round(base + randn()*sd), 10, 99),
    mental:          clamp(Math.round(base + randn()*sd), 10, 99),
  };

  // small position/age tweaks (younger players slightly more competitive/work-ethic)
  if (age <= 22) { t.workEthic = clamp(t.workEthic + 4, 10, 99); }
  if (pos === 'C') { t.chemistry = clamp(t.chemistry + 3, 10, 99); }
  return t;
}

function calcOVR(p){
  const r = p.ratings || {};
  const w = {
    ins:0.10, mid:0.08, tp:0.12, ft:0.04,
    pass:0.10, handle:0.10,
    reb:0.12, def:0.12, iq:0.12,
    ath:0.10
  };

  let s = 0, wt = 0;
  for (const k in w){
    const val = (typeof r[k] === "number") ? r[k] : 50;
    s += val * w[k];
    wt += w[k];
  }
  return Math.round(s / wt);
}

function renderRoster(){
  const team = getTeam();
  ensureRosterMeta(team);

  const totalMin = team.players.reduce((s,p)=>s+(p.minutes||0),0);

  document.getElementById("viewHint").textContent =
    `Depth chart ‚Ä¢ Total minutes: ${totalMin}/240`;

  const controls = `
    <div class="row" style="margin-bottom:12px;">
      <button class="btn primary" id="btnAutoMinutes">Auto Minutes</button>
      <button class="btn" id="btnZeroMinutes">Zero All</button>
      <span class="muted" style="margin-left:auto;">Tip: Use arrows to set depth order within a position.</span>
    </div>
  `;

  function groupHTML(pos){
    const players = team.players
      .filter(p=>p.pos===pos)
      .map(p=>({ ...p, ovr: calcOVR(p) }));

    if (players.length === 0){
      return `
        <div class="muted" style="margin:10px 0 16px;">No ${pos}s on roster.</div>
      `;
    }

    const rows = players.map((p, idx) => `
      <tr>
        <td style="width:70px;">
          <strong>${pos}${idx===0 ? "1" : idx===1 ? "2" : idx===2 ? "3" : ""}</strong>
        </td>
        <td>
          <button class="linklike" data-player="${p.id}"><strong>${p.name}</strong></button>
          <div class="muted">${p.role} ‚Ä¢ Age ${p.age}</div>
        </td>
        <td class="right" style="width:60px;"><strong>${p.ovr}</strong></td>
        <td style="width:140px;">${barHTML(p.ovr, 99)}</td>
        <td class="right" style="width:90px;">
          <input
            data-minutes
            data-id="${p.id}"
            type="number"
            min="0"
            max="48"
            value="${p.minutes ?? 0}"
            style="text-align:right; padding:10px 10px;"
          />
        </td>
        <td style="width:120px;">
          <div class="row" style="gap:6px; justify-content:flex-end;">
            <button class="btn" data-move data-pos="${pos}" data-id="${p.id}" data-dir="-1" title="Move up">‚ñ≤</button>
            <button class="btn" data-move data-pos="${pos}" data-id="${p.id}" data-dir="1"  title="Move down">‚ñº</button>
          </div>
        </td>
      </tr>
    `).join("");

    return `
      <div class="card" style="box-shadow:none; margin-bottom:12px;">
        <div class="hd"><div class="title">${pos} Depth</div></div>
        <div class="bd" style="padding:0;">
          <table>
            <thead>
              <tr>
                <th style="width:70px;">Slot</th>
                <th>Player</th>
                <th class="right" style="width:60px;">OVR</th>
                <th style="width:140px;">Bar</th>
                <th class="right" style="width:90px;">Min</th>
                <th style="width:120px;"></th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  const sections = POS_ORDER.map(groupHTML).join("");

  return `
    ${controls}
    <div class="callout" style="margin-bottom:12px;">
      <div class="muted">Team</div>
      <div class="big">${team.abbrev} ‚Äî ${team.name}</div>
      <div class="muted">Record: ${team.wins}-${team.losses} ‚Ä¢ Team OVR: ${teamOVR(team)}</div>
    </div>
    ${sections}
  `;
}

// Roster helpers (ensure these are defined before renderRoster)
const POS_ORDER = ["PG","SG","SF","PF","C"];

function getTeam(){
  return state.teams.find(t => t.id === state.userTeamId);
}

function ensureRosterMeta(team){
  if (!team || !team.players) return;
  for (const p of team.players){
    if (typeof p.minutes !== "number") p.minutes = 0;
    if (!p.role) p.role = "Rotation";
    if (!p.traits) p.traits = makeTraits(p.pos, p.age);
  }
}
function autoAllocateMinutes(team){
  ensureRosterMeta(team);
  for (const p of team.players) p.minutes = 0;

  for (const pos of POS_ORDER){
    const group = team.players.filter(p => p.pos === pos)
      .map(p => ({...p, ovr: calcOVR(p)}))
      .sort((a,b)=> b.ovr - a.ovr);

    const ids = group.slice(0,3).map(x => x.id);
    const starterId = ids[0];
    const benchId = ids[1];
    const reserveId = ids[2];

    for (const p of team.players){
      if (p.id === starterId) { p.minutes = 32; p.role = "Starter"; }
      if (p.id === benchId)   { p.minutes = 12; p.role = "Rotation"; }
      if (p.id === reserveId) { p.minutes = 4;  p.role = "Bench"; }
    }
  }

  const total = () => team.players.reduce((s,p)=>s+(p.minutes||0),0);
  let t = total();

  const sorted = [...team.players].map(p=>({id:p.id, ovr: calcOVR(p)})).sort((a,b)=>b.ovr-a.ovr);

  // Distribute remaining minutes with trait adjustments
  while (t < 240){
    let changed = false;
    for (const x of sorted){
      const p = team.players.find(pp=>pp.id===x.id);
      if (!p) continue;

      // trait influence
      const tr = p.traits || {};
      const egoAdj = Math.round(((tr.ego || 50) - 50) / 10); // ego adds desired minutes
      const discipline = (tr.discipline || 50);
      const chemistry = (tr.chemistry || 50);

      // Determine max allowed increase for this player this loop
      const maxInc = discipline >= 65 ? 1 : discipline >= 50 ? 2 : 3;

      // Apply ego desire as small instant bump but bounded by maxInc
      const want = Math.max(0, Math.min(maxInc, egoAdj));
      if (p.minutes < 36){
        p.minutes += (1 + want);
        // chemistry penalty: low chemistry slightly caps total minutes
        if ((chemistry || 50) < 50){
          const cap = Math.max(0, 36 - Math.round((50 - chemistry)/10));
          if (p.minutes > cap) p.minutes = cap;
        }
        t = total(); changed = true;
        if (t >= 240) break;
      }
    }
    if (!changed) break;
  }

  // If we overshot due to adjustments, trim from lowest ovr players, respecting discipline/ego
  while (t > 240){
    let changed = false;
    for (const x of [...sorted].reverse()){
      const p = team.players.find(pp=>pp.id===x.id);
      if (!p) continue;
      if (p.minutes > 0){
        // players with high discipline resist drops slightly
        const disc = (p.traits?.discipline || 50);
        const dec = disc >= 65 ? 1 : 2;
        p.minutes = Math.max(0, p.minutes - dec);
        t = total(); changed = true;
        if (t <= 240) break;
      }
    }
    if (!changed) break;
  }
}

function swapDepth(team, pos, playerId, dir){
  const idxs = team.players
    .map((p,i)=>({p,i}))
    .filter(x => x.p.pos === pos);

  const current = idxs.findIndex(x => x.p.id === playerId);
  if (current < 0) return;

  const target = current + dir;
  if (target < 0 || target >= idxs.length) return;

  const iA = idxs[current].i;
  const iB = idxs[target].i;

  const tmp = team.players[iA];
  team.players[iA] = team.players[iB];
  team.players[iB] = tmp;
}

function teamOVR(team){
  const top = [...team.players].map(calcOVR).sort((a,b)=>b-a).slice(0,8);
  const avg = top.reduce((s,n)=>s+n,0) / Math.max(1, top.length);
  return Math.round(avg);
}

function gameScore(teamA, teamB){
  const ovrA = teamOVR(teamA);
  const ovrB = teamOVR(teamB);
  const base = 95;
  const a = Math.round(base + (ovrA - 60) * 1.2 + rngInt(-18, 18));
  const b = Math.round(base + (ovrB - 60) * 1.2 + rngInt(-18, 18));
  return { a: Math.max(65,a), b: Math.max(65,b) };
}

function barHTML(value, max=100){
  const w = clamp(Math.round((value/max)*100), 0, 100);
  return `<div class="bar" title="${value}"><i style="width:${w}%"></i></div>`;
}

function pct(t){ const g=t.wins+t.losses; return g ? (t.wins/g) : 0; }

/** =========================================================
 *  Save/Load (localStorage)
 *  ========================================================= */
const SAVE_KEY = "hoopsDynastySave_v02";

function hasSave(){ return !!localStorage.getItem(SAVE_KEY); }

function saveLeague(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  updateFOButtons();
}

function loadLeague(){
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try{
    state = JSON.parse(raw);
    return true;
  }catch(e){
    console.warn("Save corrupted", e);
    return false;
  }
}

function wipeSave(){
  localStorage.removeItem(SAVE_KEY);
  updateFOButtons();
}

function updateFOButtons(){
  const c = document.getElementById("btnContinue");
  const w = document.getElementById("btnWipeSave");
  if (!c || !w) return;
  const lib = libLoad();
  const ok = hasSave() || (lib && lib.leagues && lib.leagues.length > 0);
  c.disabled = !ok;
  w.disabled = !ok;
}

function renderTeamPickTable(){
  const body = document.getElementById("teamPickBody");
  const label = document.getElementById("pickedTeamLabel");
  if (!body || !label) return;

  body.innerHTML = "";

  TEAMS_30.forEach((t, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.abbrev = t.abbrev;
    if (t.abbrev === selectedCreateTeamAbbrev) tr.classList.add("selected");

    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td><strong>${t.abbrev}</strong></td>
      <td><strong>${t.city} ${t.name}</strong></td>
      <td class="market-${t.market}">${t.market}</td>
      <td class="muted">${t.conference}</td>
      <td class="muted">${t.division}</td>
    `;

    tr.addEventListener("click", () => {
      selectedCreateTeamAbbrev = t.abbrev;
      renderTeamPickTable();
    });

    body.appendChild(tr);
  });

  const picked = TEAMS_30.find(x => x.abbrev === selectedCreateTeamAbbrev) || TEAMS_30[0];
  label.textContent = `${picked.abbrev} ‚Äî ${picked.city} ${picked.name}`;
}

// ===== Multi-League Save System =====
const LIB_KEY = "hoopsDynasty_leagueLibrary_v1";

function libLoad(){
  const raw = localStorage.getItem(LIB_KEY);
  if (!raw) return { leagues: [] };
  try { return JSON.parse(raw); } catch { return { leagues: [] }; }
}

function libSave(lib){
  localStorage.setItem(LIB_KEY, JSON.stringify(lib));
}

function makeLeagueRecordFromState(st){
  const userTeam = st.teams?.find(t => t.id === st.userTeamId);
  return {
    id: crypto.randomUUID(),
    name: st.leagueName || "HOOPS DYNASTY",
    seasonYear: st.seasonYear || 2026,
    seasonNumber: st.seasonNumber || 1,
    userTeamAbbrev: userTeam?.abbrev || "‚Äî",
    updatedAt: Date.now(),
    state: st,
  };
}

function libUpsertLeague(record){
  const lib = libLoad();
  const idx = lib.leagues.findIndex(l => l.id === record.id);
  if (idx >= 0) lib.leagues[idx] = record;
  else lib.leagues.unshift(record);
  libSave(lib);
  updateFOButtons();
}

function libDeleteLeague(id){
  const lib = libLoad();
  lib.leagues = lib.leagues.filter(l => l.id !== id);
  libSave(lib);
  updateFOButtons();
}

function libRenameLeague(id, newName){
  const lib = libLoad();
  const l = lib.leagues.find(x => x.id === id);
  if (!l) return;
  l.name = newName;
  l.state.leagueName = newName;
  l.updatedAt = Date.now();
  libSave(lib);
  updateFOButtons();
}

function libGetLeague(id){
  const lib = libLoad();
  return lib.leagues.find(l => l.id === id) || null;
}

function fmtDate(ts){ const d = new Date(ts); return d.toLocaleString(); }

let activeLeagueId = null;

function saveActiveLeague(){
  if (!activeLeagueId) return;
  const lib = libLoad();
  const l = lib.leagues.find(x => x.id === activeLeagueId);
  if (!l) return;

  l.state = state;
  l.name = state.leagueName;
  l.seasonYear = state.seasonYear;
  l.seasonNumber = state.seasonNumber;
  const userTeam = state.teams?.find(t => t.id === state.userTeamId);
  l.userTeamAbbrev = userTeam?.abbrev || l.userTeamAbbrev;
  l.updatedAt = Date.now();

  libSave(lib);
}

// Persist save: use active library record when available, otherwise fall back
function persistSave(){
  if (activeLeagueId) return saveActiveLeague();
  return saveLeague();
}

function renderLeagueManager(){
  console.log("LeagueManager:", libLoad());
  const body = document.getElementById("leagueTableBody");
  if (!body) return;
  const lib = libLoad();
  body.innerHTML = "";
  if (!lib.leagues || lib.leagues.length === 0){
    body.innerHTML = `<tr><td colspan="4" class="muted">No saved leagues yet.</td></tr>`;
    return;
  }
  for (const l of lib.leagues){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        <strong>${escapeHtml(l.name)}</strong>
        <div class="muted">${l.userTeamAbbrev} ‚Ä¢ League ID: ${l.id.slice(0,8)}</div>
      </td>
      <td>${(l.seasonYear || "‚Äî")} (S${l.seasonNumber || 1})</td>
      <td class="muted">${fmtDate(l.updatedAt)}</td>
      <td>
        <div class="actions">
          <button class="btn primary" data-act="load" data-id="${l.id}">Load</button>
          <button class="btn" data-act="rename" data-id="${l.id}">Rename</button>
          <button class="btn" data-act="export" data-id="${l.id}">Export</button>
          <button class="btn danger" data-act="delete" data-id="${l.id}">Delete</button>
        </div>
      </td>
    `;
    body.appendChild(tr);
  }
}

function escapeHtml(s){ return String(s).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"','&quot;').replaceAll("'","&#039;"); }

function downloadJSON(filename, dataObj){
  const blob = new Blob([JSON.stringify(dataObj, null, 2)], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/** =========================================================
 *  App state
 *  ========================================================= */
let state = {
  leagueName: "HOOPS DYNASTY",
  seasonYear: 2026,
  seasonNumber: 1,
  day: 1,
  view: "standings",
  standingsScope: "league",
  userTeamId: null,
  teams: [],
  schedule: [],
  log: [],
};

let selectedCreateTeamAbbrev = "POR";

function logLine(msg){
  state.log.unshift(`[Day ${state.day}] ${msg}`);
  state.log = state.log.slice(0, 14);
  const el = document.getElementById("log");
  if (el) el.textContent = state.log.join("\n");
}

function buildTeamsFromTemplate(){
  return TEAMS_30.map(t => ({
    id: crypto.randomUUID(),
    abbrev: t.abbrev,
    city: t.city,
    nickname: t.name,
    name: `${t.city} ${t.name}`,
    market: t.market,
    conference: t.conference,
    division: t.division,
    wins: 0,
    losses: 0,

    homeW: 0, homeL: 0,
    roadW: 0, roadL: 0,
    confW: 0, confL: 0,
    last10: [],
    streak: 0,

    players: [],
  }));
}

// Standings helpers
function winPct(t){
  const g = (t.wins || 0) + (t.losses || 0);
  return g ? (t.wins / g) : 0;
}

function sortTeamsForStandings(list){
  return [...list].sort((a,b)=>{
    if (b.wins !== a.wins) return b.wins - a.wins;
    const dp = winPct(b) - winPct(a);
    if (dp !== 0) return dp;
    return teamOVR(b) - teamOVR(a);
  });
}

function gamesBack(leader, team){
  const gb = ((leader.wins - team.wins) + (team.losses - leader.losses)) / 2;
  return gb === 0 ? "‚Äî" : gb.toFixed(1);
}

function l10Str(team){
  const arr = team.last10 || [];
  const w = arr.filter(x=>x==="W").length;
  const l = arr.filter(x=>x==="L").length;
  return `${w}-${l}`;
}

function streakStr(team){
  const s = team.streak || 0;
  if (!s) return "‚Äî";
  return s > 0 ? `W${s}` : `L${Math.abs(s)}`;
}

function generateSchedule(teamIds, games = 300){
  // Simple: random games across season days. You can replace with proper NBA scheduling later.
  const sched = [];
  let day = 1;
  for (let i=0;i<games;i++){
    const home = teamIds[rngInt(0, teamIds.length-1)];
    let away = teamIds[rngInt(0, teamIds.length-1)];
    while (away === home) away = teamIds[rngInt(0, teamIds.length-1)];
    sched.push({ day, homeId: home, awayId: away, played:false, homeScore:null, awayScore:null });
    day++;
  }
  return sched;
}

function createLeague({leagueName, seasonYear, userTeamAbbrev}){
  state.leagueName = leagueName;
  state.seasonYear = seasonYear;
  state.seasonNumber = 1;
  state.day = 1;
  state.view = "dashboard";
  state.log = [];

  // default name set (Men|Women|Mixed)
  state.nameSet = state.nameSet || "Mixed";

  state.teams = buildTeamsFromTemplate();

  // Fill rosters
  for (const team of state.teams){
    team.wins = 0; team.losses = 0;
    team.homeW = 0; team.homeL = 0;
    team.roadW = 0; team.roadL = 0;
    team.confW = 0; team.confL = 0;
    team.last10 = [];
    team.streak = 0;
    team.players = [];
    for (let i=0;i<10;i++){
      const p = makePlayer();
      team.players.push(p);
      attachPlayerToTeam(p, team);
    }
  }

  // Set user team by abbrev
  const userTeam = state.teams.find(t => t.abbrev === userTeamAbbrev) || state.teams[0];
  state.userTeamId = userTeam.id;

  state.schedule = generateSchedule(state.teams.map(t=>t.id), 360); // ~360 days/games (toy)

  logLine(`League created: ${state.leagueName} (${state.seasonYear})`);
  // Create a new league record and set active
  const rec = makeLeagueRecordFromState(state);
  rec.name = leagueName;
  rec.seasonYear = seasonYear;
  rec.state.leagueName = leagueName;
  rec.state.seasonYear = seasonYear;

  activeLeagueId = rec.id;
  libUpsertLeague(rec);

  renderAll();
}

/** =========================================================
 *  Sim actions
 *  ========================================================= */
function gamesLeft(){ return state.schedule.filter(g=>!g.played).length; }

function nextGameForUser(){
  const uid = state.userTeamId;
  return state.schedule.find(g => !g.played && (g.homeId===uid || g.awayId===uid));
}

function simSpecificGame(game){
  // helper for last10 and streak
  function pushLast10(team, result){ // result: "W" or "L"
    team.last10 = team.last10 || [];
    team.last10.push(result);
    if (team.last10.length > 10) team.last10.shift();
  }

  function updateStreak(team, result){
    team.streak = team.streak || 0;
    if (result === "W") team.streak = team.streak >= 0 ? team.streak + 1 : 1;
    else team.streak = team.streak <= 0 ? team.streak - 1 : -1;
  }

  const home = state.teams.find(t=>t.id===game.homeId);
  const away = state.teams.find(t=>t.id===game.awayId);
  const s = gameScore(home, away);

  game.played = true;
  game.homeScore = s.a;
  game.awayScore = s.b;

  const homeWon = s.a > s.b;

  // overall record
  if (homeWon){ home.wins++; away.losses++; }
  else { away.wins++; home.losses++; }

  // home/road record
  if (homeWon){ home.homeW++; away.roadL++; }
  else { home.homeL++; away.roadW++; }

  // conference record (only if same conference)
  const sameConf = home.conference && away.conference && home.conference === away.conference;
  if (sameConf){
    if (homeWon){ home.confW++; away.confL++; }
    else { away.confW++; home.confL++; }
  }

  // last 10 + streak
  pushLast10(home, homeWon ? "W" : "L");
  pushLast10(away, homeWon ? "L" : "W");
  updateStreak(home, homeWon ? "W" : "L");
  updateStreak(away, homeWon ? "L" : "W");

  logLine(`${away.abbrev} ${s.b} @ ${home.abbrev} ${s.a}`);
}

function advanceDay(){
  const todays = state.schedule.filter(g => g.day === state.day && !g.played);
  for (const g of todays) simSpecificGame(g);

  const next = state.schedule.find(g=>!g.played);
  if (!next){
    // run end-of-season processing
    endSeason();
  } else {
    state.day = Math.max(state.day + 1, next.day);
  }

  saveActiveLeague();
  renderAll();
}

function endSeason(){
  logLine("Season complete. Running end-of-season development.");
  // snapshot history
  snapshotRosterHistory();

  // Simple development tick: growth and decline influenced by traits
  for (const team of state.teams){
    for (const p of team.players){
      if (!p.ratings) p.ratings = makeAttributes(p.pos, p.age);
      if (!p.traits) p.traits = makeTraits(p.pos, p.age);

      // base growth/decline by age
      let growth = 0;
      let decline = 0;
      if (p.age <= 22) growth = 3;
      else if (p.age <= 26) growth = 2;
      else if (p.age <= 30) growth = 1;
      else decline = 2;

      // apply trait multipliers per request
      const work = (p.traits.workEthic || 50);
      const mental = (p.traits.mental || 50);
      growth = growth * (work / 50);
      decline = decline * (1 - (mental / 200));

      // apply to ratings
      const beforeOVR = calcOVR(p);
      for (const k of Object.keys(p.ratings)){
        const up = Math.round(growth * Math.random());
        const down = Math.round(decline * Math.random());
        p.ratings[k] = clamp((p.ratings[k] || 50) + up - down, 25, 99);
      }

      // age player
      p.age = (p.age || 20) + 1;

      // record history entry
      if (!p.history) p.history = [];
      p.history.push({
        ts: Date.now(),
        seasonYear: state.seasonYear,
        teamId: team.id,
        type: 'DEVELOP',
        note: `Development tick: +${Math.round(growth)} / -${Math.round(decline)}`,
        ovr: calcOVR(p),
        age: p.age,
      });
    }
  }

  // advance season counters
  state.seasonNumber = (state.seasonNumber || 1) + 1;
  state.seasonYear = (state.seasonYear || (new Date()).getFullYear()) + 1;
  state.day = 1;
  logLine(`Season advanced to ${state.seasonYear} (S${state.seasonNumber})`);
}

function simOneGame(){
  const g = state.schedule.find(g=>!g.played);
  if (!g){ logLine("No games left."); renderAll(); return; }
  state.day = Math.max(state.day, g.day);
  simSpecificGame(g);
  saveActiveLeague();
  renderAll();
}

/** =========================================================
 *  Rendering
 *  ========================================================= */
function showScreen(name){
  const ids = [
    "splashScreen",
    "frontOfficeScreen",
    "createLeagueScreen",
    "leagueManagerScreen",
    "appScreen",
  ];

  for (const id of ids){
    const el = document.getElementById(id);
    if (el) el.classList.add("hide");
  }

  const map = {
    splash: "splashScreen",
    frontOffice: "frontOfficeScreen",
    createLeague: "createLeagueScreen",
    leagueManager: "leagueManagerScreen",
    app: "appScreen",
  };

  const target = document.getElementById(map[name]);
  if (target) target.classList.remove("hide");
  else console.warn("Unknown screen:", name);
}

function renderTop(){
  document.getElementById("topTitle").textContent = `${state.leagueName}`;
  document.getElementById("topSub").textContent = `Season Year: ${state.seasonYear}`;
  document.getElementById("pillSeason").textContent = `Season ${state.seasonNumber}`;
  document.getElementById("pillDay").textContent = `Day ${state.day}`;
  document.getElementById("pillGamesLeft").textContent = `${gamesLeft()} games left`;
}

function renderTeamSelectApp(){
  const sel = document.getElementById("selUserTeam");
  sel.innerHTML = "";
  for (const t of state.teams){
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = `${t.abbrev} ‚Äî ${t.name}`;
    sel.appendChild(opt);
  }
  sel.value = state.userTeamId;
}

function renderNextGame(){
  const g = nextGameForUser();
  const big = document.getElementById("nextGameText");
  const sub = document.getElementById("nextGameSub");
  if (!g){ big.textContent="No remaining games"; sub.textContent="Schedule is cooked. (End Season comes next.)"; return; }
  const home = state.teams.find(t=>t.id===g.homeId);
  const away = state.teams.find(t=>t.id===g.awayId);
  big.textContent = `${away.abbrev} @ ${home.abbrev}`;
  sub.textContent = `Day ${g.day} ‚Ä¢ ${away.name} vs ${home.name}`;
}

function formatPct(team){
  const g = (team.wins || 0) + (team.losses || 0);
  return g ? (team.wins / g) : 0;
}

function formatGB(leader, team){
  const gb = ((leader.wins - team.wins) + (team.losses - leader.losses)) / 2;
  return gb === 0 ? "‚Äî" : gb.toFixed(1);
}

function formatL10(team){
  const arr = team.last10 || [];
  const w = arr.filter(x=>x==="W").length;
  const l = arr.filter(x=>x==="L").length;
  return `${w}-${l}`;
}

function formatStreak(team){
  if (!team.streak) return "‚Äî";
  return team.streak > 0 ? `W${team.streak}` : `L${Math.abs(team.streak)}`;
}

function renderStandings(){
  const uid = state.userTeamId;

  // Scope: league, East, West
  const scope = state.standingsScope || "league";

  let pool = state.teams;
  if (scope === "East" || scope === "West"){
    pool = state.teams.filter(t => t.conference === scope);
  }

  const teams = sortTeamsForStandings(pool);
  const leader = teams[0] || null;

  document.getElementById("viewHint").textContent =
    (scope === "league")
      ? "League standings"
      : `${scope} standings`;

  const toggle = `
    <div class="row" style="justify-content:flex-start; gap:10px; margin-bottom:12px;">
      <button class="btn ${scope==="league" ? "primary" : ""}" data-scope="league">League</button>
      <button class="btn ${scope==="East" ? "primary" : ""}" data-scope="East">East</button>
      <button class="btn ${scope==="West" ? "primary" : ""}" data-scope="West">West</button>
      <div class="muted" style="margin-left:auto;">
        GB = ${scope==="league" ? "league leader" : "conference leader"}
      </div>
    </div>
  `;

  if (!leader){
    return toggle + `<div class="muted">No teams found.</div>`;
  }

  const rows = teams.map(t=>{
    const isUser = t.id === uid;
    const pct = (winPct(t)*100).toFixed(1) + "%";

    // GB is relative to leader of *current scope* (league or conference)
    const gb = gamesBack(leader, t);

    const confRec = `${t.confW ?? 0}-${t.confL ?? 0}`;
    const homeRec = `${t.homeW ?? 0}-${t.homeL ?? 0}`;
    const roadRec = `${t.roadW ?? 0}-${t.roadL ?? 0}`;

    return `
      <tr style="${isUser ? 'background: rgba(110,231,255,.06);' : ''}">
        <td>
          <strong>${t.abbrev}</strong>
          <span class="muted">(${t.name})</span>
          ${isUser ? `<span class="badge"><span class="dot"></span>YOU</span>` : ``}
        </td>
        <td class="right">${t.wins}-${t.losses}</td>
        <td class="right">${pct}</td>
        <td class="right">${gb}</td>
        <td class="right">${confRec}</td>
        <td class="right">${homeRec}</td>
        <td class="right">${roadRec}</td>
        <td class="right">${l10Str(t)}</td>
        <td class="right">${streakStr(t)}</td>
      </tr>
    `;
  }).join("");

  return `
    ${toggle}
    <table>
      <thead>
        <tr>
          <th>Team</th>
          <th class="right">Record</th>
          <th class="right">Win%</th>
          <th class="right">GB</th>
          <th class="right">Conf</th>
          <th class="right">Home</th>
          <th class="right">Road</th>
          <th class="right">L10</th>
          <th class="right">Streak</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderRoster(){
  const team = getTeam();
  ensureRosterMeta(team);

  const totalMin = team.players.reduce((s,p)=>s+(p.minutes||0),0);

  document.getElementById("viewHint").textContent =
    `Depth chart ‚Ä¢ Total minutes: ${totalMin}/240`;

  const controls = `
    <div class="row" style="margin-bottom:12px;">
      <button class="btn primary" id="btnAutoMinutes">Auto Minutes</button>
      <button class="btn" id="btnZeroMinutes">Zero All</button>
      <span class="muted" style="margin-left:auto;">Tip: Use arrows to set depth order within a position.</span>
    </div>
  `;

  function groupHTML(pos){
    const players = team.players
      .filter(p=>p.pos===pos)
      .map(p=>({ ...p, ovr: calcOVR(p) }));

    if (players.length === 0){
      return `
        <div class="muted" style="margin:10px 0 16px;">No ${pos}s on roster.</div>
      `;
    }

    const rows = players.map((p, idx) => `
      <tr>
        <td style="width:70px;">
          <strong>${pos}${idx===0 ? "1" : idx===1 ? "2" : idx===2 ? "3" : ""}</strong>
        </td>
        <td>
          <button class="linklike" data-player="${p.id}"><strong>${p.name}</strong></button>
          <div class="muted">${p.role} ‚Ä¢ Age ${p.age}</div>
        </td>
        <td class="right" style="width:60px;"><strong>${p.ovr}</strong></td>
        <td style="width:140px;">${barHTML(p.ovr, 99)}</td>
        <td class="right" style="width:90px;">
          <input
            data-minutes
            data-id="${p.id}"
            type="number"
            min="0"
            max="48"
            value="${p.minutes ?? 0}"
            style="text-align:right; padding:10px 10px;"
          />
        </td>
        <td style="width:120px;">
          <div class="row" style="gap:6px; justify-content:flex-end;">
            <button class="btn" data-move data-pos="${pos}" data-id="${p.id}" data-dir="-1" title="Move up">‚ñ≤</button>
            <button class="btn" data-move data-pos="${pos}" data-id="${p.id}" data-dir="1"  title="Move down">‚ñº</button>
          </div>
        </td>
      </tr>
    `).join("");

    return `
      <div class="card" style="box-shadow:none; margin-bottom:12px;">
        <div class="hd"><div class="title">${pos} Depth</div></div>
        <div class="bd" style="padding:0;">
          <table>
            <thead>
              <tr>
                <th style="width:70px;">Slot</th>
                <th>Player</th>
                <th class="right" style="width:60px;">OVR</th>
                <th style="width:140px;">Bar</th>
                <th class="right" style="width:90px;">Min</th>
                <th style="width:120px;"></th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      </div>
    `;
  }

  const sections = POS_ORDER.map(groupHTML).join("");

  return `
    ${controls}
    <div class="callout" style="margin-bottom:12px;">
      <div class="muted">Team</div>
      <div class="big">${team.abbrev} ‚Äî ${team.name}</div>
      <div class="muted">Record: ${team.wins}-${team.losses} ‚Ä¢ Team OVR: ${teamOVR(team)}</div>
    </div>
    ${sections}
  `;
}

function renderDashboard(){
  const team = state.teams.find(t=>t.id===state.userTeamId);
  const ovr = teamOVR(team);

  const top = [...team.players]
    .map(p=>({ ...p, ovr: calcOVR(p) }))
    .sort((a,b)=>b.ovr-a.ovr)
    .slice(0,5);

  const topRows = top.map(p=>`
    <tr>
      <td><button class="linklike" data-player="${p.id}"><strong>${p.name}</strong></button><div class="muted">${p.pos} ‚Ä¢ Age ${p.age}</div></td>
      <td class="right"><strong>${p.ovr}</strong></td>
      <td style="width:220px">${barHTML(p.ovr, 99)}</td>
    </tr>
  `).join("");

  document.getElementById("viewHint").textContent = "Your franchise overview";

  return `
    <div class="callout" style="margin-bottom:12px;">
      <div class="muted">Franchise</div>
      <div class="big">${team.abbrev} ‚Äî ${team.name}</div>
      <div class="muted">Record: ${team.wins}-${team.losses} ‚Ä¢ Team OVR: ${ovr}</div>
    </div>

    <div class="row" style="margin-bottom:12px;">
      <div class="card" style="flex:1; box-shadow:none;">
        <div class="hd"><div class="title">Goals</div></div>
        <div class="bd">
          <div class="muted">Prototype goals (we‚Äôll make these real later)</div>
          <div style="height:8px"></div>
          <div>‚Ä¢ Build a playoff team</div>
          <div>‚Ä¢ Develop a star</div>
          <div>‚Ä¢ Don‚Äôt go broke (future)</div>
        </div>
      </div>

      <div class="card" style="flex:1; box-shadow:none;">
        <div class="hd"><div class="title">Team Identity</div></div>
        <div class="bd">
          <div class="muted">Market / Conf / Division</div>
          <div style="height:8px"></div>
          <div><strong>${team.market || "‚Äî"}</strong> market</div>
          <div>${team.conference || "‚Äî"} ‚Ä¢ ${team.division || "‚Äî"}</div>
        </div>
      </div>
    </div>

    <div class="card" style="box-shadow:none;">
      <div class="hd"><div class="title">Top Players</div></div>
      <div class="bd" style="padding:0;">
        <table>
          <thead><tr><th>Player</th><th class="right">OVR</th><th>Bar</th></tr></thead>
          <tbody>${topRows}</tbody>
        </table>
      </div>
    </div>
  `;
}

function renderPlayers(){
  const all = state.teams.flatMap(t=> t.players.map(p=>({
    id: p.id,
    team: t.abbrev,
    name: p.name,
    pos: p.pos,
    age: p.age,
    ovr: calcOVR(p),
  }))).sort((a,b)=>b.ovr-a.ovr);

  document.getElementById("viewHint").textContent = "All players (sorted by OVR)";
  const rows = all.map(p=>`
    <tr>
      <td><button class="linklike" data-player="${p.id}"><strong>${p.name}</strong></button><div class="muted">${p.team} ‚Ä¢ ${p.pos} ‚Ä¢ Age ${p.age}</div></td>
      <td class="right">${p.ovr}</td>
      <td style="width:220px">${barHTML(p.ovr, 99)}</td>
    </tr>
  `).join("");

  return `
    <table>
      <thead><tr><th>Player</th><th class="right">OVR</th><th>Bar</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function addHistoryEntry(player, patch){
  if (!player.history) player.history = [];
  player.history.push({
    ts: Date.now(),
    seasonYear: state.seasonYear,
    teamId: state.userTeamId,
    ...patch,
  });
}

function attachPlayerToTeam(player, team){
  player.teamId = team.id;
  if (!player.history) player.history = [];
  player.history.push({
    ts: Date.now(),
    seasonYear: state.seasonYear,
    teamId: team.id,
    type: "JOIN",
    note: `Joined ${team.abbrev}`,
    ovr: calcOVR(player),
    age: player.age,
  });
}

function snapshotRosterHistory(){
  for (const team of state.teams){
    for (const p of team.players){
      if (!p.history) p.history = [];
      p.history.push({
        ts: Date.now(),
        seasonYear: state.seasonYear,
        teamId: team.id,
        type: "SEASON_END",
        note: `Season ${state.seasonNumber} complete`,
        ovr: calcOVR(p),
        age: p.age,
        minutes: p.minutes || 0,
      });
    }
  }
}


function renderSchedule(){
  document.getElementById("viewHint").textContent = "Schedule (your games highlighted)";
  const rows = state.schedule.slice(0, 120).map(g=>{
    const home = state.teams.find(t=>t.id===g.homeId);
    const away = state.teams.find(t=>t.id===g.awayId);
    const isUser = (g.homeId===state.userTeamId || g.awayId===state.userTeamId);
    const line = g.played ? `${away.abbrev} ${g.awayScore} @ ${home.abbrev} ${g.homeScore}` : `${away.abbrev} @ ${home.abbrev}`;
    return `
      <tr style="${isUser ? 'background: rgba(110,231,255,.06);' : ''}">
        <td>Day ${g.day}</td>
        <td>${line} ${isUser ? `<span class="badge"><span class="dot"></span>YOUR GAME</span>` : ``}</td>
        <td class="right">${g.played ? "Final" : "Scheduled"}</td>
      </tr>
    `;
  }).join("");

  return `
    <div class="muted" style="margin-bottom:10px;">Showing first 120 games (we‚Äôll add filters later).</div>
    <table>
      <thead><tr><th>Day</th><th>Matchup</th><th class="right">Status</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderView(){
  const title = document.getElementById("viewTitle");
  const el = document.getElementById("view");

  if (state.view === "dashboard"){
    title.textContent = "Team Dashboard";
    el.innerHTML = renderDashboard();
    return;
  }

  if (state.view==="standings"){ title.textContent="Standings"; el.innerHTML = renderStandings(); return; }
  if (state.view==="roster"){ title.textContent="Roster"; el.innerHTML = renderRoster(); return; }
  if (state.view==="players"){ title.textContent="Players"; el.innerHTML = renderPlayers(); return; }
  if (state.view==="schedule"){ title.textContent="Schedule"; el.innerHTML = renderSchedule(); return; }

  if (state.view==="league"){ title.textContent="League"; document.getElementById("viewHint").textContent=""; el.innerHTML = `<div class="muted">League hub coming next.</div>`; return; }
  if (state.view==="settings"){ title.textContent="Settings"; document.getElementById("viewHint").textContent=""; el.innerHTML = `<div class="muted">Settings coming next.</div>`; return; }
}

function renderAll(){
  renderTop();
  renderTeamSelectApp();
  renderNextGame();
  renderView();
  syncSidebarActive();
  document.getElementById("log").textContent = state.log.join("\n");
}

function syncSidebarActive(){
  const items = document.querySelectorAll('.nav-item');
  if (!items) return;
  items.forEach(x=>{
    x.classList.toggle('active', x.dataset.route === state.view);
  });
}

/** =========================================================
 *  Create-league screen setup
 *  ========================================================= */
function populateCreateTeamSelect(){
  const sel = document.getElementById("selCreateTeam");
  if (!sel) return; // select replaced by table picker in newer UI
  sel.innerHTML = "";
  for (const t of TEAMS_30){
    const opt = document.createElement("option");
    opt.value = t.abbrev;
    opt.textContent = `${t.abbrev} ‚Äî ${t.city} ${t.name}`;
    sel.appendChild(opt);
  }
  sel.value = "POR"; // default
}

/** =========================================================
 *  UI wiring
 *  ========================================================= */
function attach(id, ev, handler){ const el = document.getElementById(id); if (el) el.addEventListener(ev, handler); }

attach("btnEnterFO", "click", ()=>{ updateFOButtons(); showScreen("frontOffice"); });
attach("btnGoCreate", "click", ()=>{ selectedCreateTeamAbbrev = "POR"; renderTeamPickTable(); showScreen("createLeague"); });
attach("btnBackFO", "click", ()=>{ updateFOButtons(); showScreen("frontOffice"); });

attach("btnCreateLeague", "click", ()=>{
  const leagueName = (document.getElementById("inpLeagueName")?.value || "HOOPS DYNASTY").trim();
  const seasonYear = parseInt(document.getElementById("inpSeasonYear")?.value, 10) || 2026;
  const userTeamAbbrev = selectedCreateTeamAbbrev;
  createLeague({ leagueName, seasonYear, userTeamAbbrev });
  showScreen("app");
});

attach("btnContinue", "click", ()=>{ renderLeagueManager(); showScreen("leagueManager"); });
attach("btnBackFO2", "click", ()=>{ updateFOButtons(); showScreen("frontOffice"); });
attach("btnWipeSave", "click", wipeSave);
attach("btnHome", "click", ()=>{ updateFOButtons(); showScreen("frontOffice"); });

attach("btnNewLeagueQuick", "click", ()=>{ const userTeam = state.teams.find(t=>t.id===state.userTeamId); const abbrev = userTeam ? userTeam.abbrev : "POR"; createLeague({ leagueName: state.leagueName, seasonYear: state.seasonYear, userTeamAbbrev: abbrev }); });

attach("btnAdvanceDay", "click", advanceDay);
attach("btnSimGame", "click", simOneGame);

const _selUserTeam = document.getElementById("selUserTeam");
if (_selUserTeam){ _selUserTeam.addEventListener("change", (e)=>{ state.userTeamId = e.target.value; persistSave(); renderAll(); }); }

const _tabsEl = document.getElementById("tabs");
if (_tabsEl){
  _tabsEl.addEventListener("click", (e)=>{
    const tab = e.target.closest(".tab");
    if (!tab) return;
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    state.view = tab.dataset.view;
    persistSave();
    renderView();
  });
}

// Sidebar nav handler
const _nav = document.querySelector('.sidebar .nav');
if (_nav){
  _nav.addEventListener('click', (e)=>{
    const btn = e.target.closest('.nav-item');
    if (!btn) return;
    document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));
    btn.classList.add('active');
    state.view = btn.dataset.route;
    // prefer active-library save if present
    if (typeof saveActiveLeague === 'function') saveActiveLeague();
    renderView();
  });
}

// Delegated handlers on main view (standings toggle + roster controls)
const _viewEl = document.getElementById("view");
if (_viewEl){
  _viewEl.addEventListener("click", (e)=>{
    // Auto Minutes
    if (e.target && e.target.id === "btnAutoMinutes"){
      const team = getTeam();
      autoAllocateMinutes(team);
      saveActiveLeague?.();
      renderView();
      return;
    }

    // Zero All
    if (e.target && e.target.id === "btnZeroMinutes"){
      const team = getTeam();
      ensureRosterMeta(team);
      for (const p of team.players){ p.minutes = 0; p.role = "Rotation"; }
      saveActiveLeague?.();
      renderView();
      return;
    }

    // Move up/down within position
    const moveBtn = e.target.closest("button[data-move]");
    if (moveBtn){
      const team = getTeam();
      const pos = moveBtn.dataset.pos;
      const id = moveBtn.dataset.id;
      const dir = parseInt(moveBtn.dataset.dir, 10);
      swapDepth(team, pos, id, dir);
      saveActiveLeague?.();
      renderView();
      return;
    }

    // Standings scope (original behavior)
    const scopeBtn = e.target.closest("button[data-scope]");
    if (scopeBtn){
      state.standingsScope = scopeBtn.dataset.scope;
      if (typeof saveActiveLeague === 'function') saveActiveLeague();
      renderView();
      return;
    }
  });

  // Minutes input handling
  _viewEl.addEventListener("input", (e)=>{
    const inp = e.target.closest("input[data-minutes]");
    if (!inp) return;

    const team = getTeam();
    const id = inp.dataset.id;
    const p = team.players.find(x=>x.id===id);
    if (!p) return;

    let v = parseInt(inp.value, 10);
    if (Number.isNaN(v)) v = 0;
    p.minutes = Math.max(0, Math.min(48, v));

    if (p.minutes >= 28) p.role = "Starter";
    else if (p.minutes >= 12) p.role = "Rotation";
    else if (p.minutes > 0) p.role = "Bench";
    else p.role = "Rotation";

    saveActiveLeague?.();
    // no full re-render while typing to avoid jitter
  });
}

// Sidebar collapse toggle + persistence
const SHELL_KEY = "hoopsDynasty_sidebarCollapsed_v1";
function setSidebarCollapsed(collapsed){
  const shell = document.querySelector('.app-shell');
  if (!shell) return;
  shell.classList.toggle('is-collapsed', !!collapsed);
  localStorage.setItem(SHELL_KEY, collapsed ? '1' : '0');
}

// attach toggle button safely
const _btnToggle = document.getElementById('btnToggleSidebar');
if (_btnToggle){
  _btnToggle.addEventListener('click', ()=>{
    const shell = document.querySelector('.app-shell');
    if (!shell) return;
    const collapsed = !shell.classList.contains('is-collapsed');
    setSidebarCollapsed(collapsed);
  });
}

// Restore preference on load
setSidebarCollapsed(localStorage.getItem(SHELL_KEY) === '1');

// League Manager action handlers (load / rename / export / delete)
const _leagueBody = document.getElementById("leagueTableBody");
if (_leagueBody){
  _leagueBody.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    if (!act || !id) return;

    if (act === "load"){
      const rec = libGetLeague(id);
      if (!rec) return alert("League not found.");
        state = rec.state;
        activeLeagueId = id;
        state.view = state.view || "dashboard";
        renderAll();
        showScreen("app");
      return;
    }

    if (act === "rename"){
      const newName = prompt("New league name:", "" );
      if (!newName) return;
      libRenameLeague(id, newName.trim());
      renderLeagueManager();
      return;
    }

    if (act === "export"){
      const rec = libGetLeague(id);
      if (!rec) return alert("League not found.");
      const filename = `${rec.name.replaceAll(/[^a-z0-9\-_ ]/gi, '') || 'league'}-${rec.id.slice(0,8)}.json`;
      downloadJSON(filename, rec.state);
      return;
    }

    if (act === "delete"){
      if (!confirm("Delete this saved league? This cannot be undone.")) return;
      libDeleteLeague(id);
      if (activeLeagueId === id) activeLeagueId = null;
      renderLeagueManager();
      return;
    }
  });
}

// Import league JSON file handler
const _importFile = document.getElementById("importFile");
if (_importFile){
  _importFile.addEventListener("change", async (e)=>{
    const f = e.target.files && e.target.files[0];
    if (!f) return;
    try {
      const txt = await f.text();
      const parsed = JSON.parse(txt);
      const rec = makeLeagueRecordFromState(parsed);
      rec.state = parsed;
      libUpsertLeague(rec);
      activeLeagueId = rec.id;
      renderLeagueManager();
      alert("League imported and added to library.");
    } catch (err){
      alert("Import failed: " + (err && err.message ? err.message : err));
    } finally {
      _importFile.value = "";
    }
  });
}

// boot
updateFOButtons();
renderTeamPickTable();
showScreen("splash");
</script>

<!-- PLAYER MODAL -->
<div id="playerModal" class="modal hide" aria-hidden="true">
  <div class="modal-backdrop" data-close="1"></div>
  <div class="modal-card">
    <div class="modal-hd">
      <div>
        <div class="modal-title" id="pmName">Player</div>
        <div class="muted" id="pmSub">‚Äî</div>
      </div>
      <button class="btn" id="pmClose">Close</button>
    </div>
    <div class="modal-bd" id="pmBody"></div>
  </div>
</div>

<script>
function findPlayerById(pid){
  for (const t of state.teams){
    const p = t.players?.find(x => x.id === pid);
    if (p) return { team: t, player: p };
  }
  return null;
}

function openPlayerModal(pid){
  const found = findPlayerById(pid);
  if (!found) return;

  const { team, player } = found;
  const ovr = calcOVR(player);

  const pmName = document.getElementById("pmName");
  const pmSub = document.getElementById("pmSub");
  const pmBody = document.getElementById("pmBody");
  if (!pmName || !pmSub || !pmBody) return;

  pmName.textContent = player.name;
  pmSub.textContent = `${player.pos} ‚Ä¢ Age ${player.age} ‚Ä¢ OVR ${ovr} ‚Ä¢ ${team.abbrev} ‚Äî ${team.name}`;

  const r = player.ratings || {};
  const LABELS = {
    ins:"Inside", mid:"Mid", tp:"3PT", ft:"FT",
    pass:"Pass", handle:"Handle",
    reb:"Reb", def:"Defense", iq:"IQ", ath:"Ath"
  };

  function topKeys(obj, n=2){ return Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,n).map(x=>x[0]); }
  function bottomKeys(obj, n=2){ return Object.entries(obj).sort((a,b)=>a[1]-b[1]).slice(0,n).map(x=>x[0]); }

  const strengths = topKeys(r,3).map(k=>LABELS[k]||k).join(", ");
  const weaknesses = bottomKeys(r,3).map(k=>LABELS[k]||k).join(", ");

  const ratingRows = Object.keys(r).map(k => `
    <tr>
      <td><strong>${LABELS[k] || k}</strong></td>
      <td class="right"><strong>${r[k]}</strong></td>
      <td style="width:240px">${barHTML(r[k], 99)}</td>
    </tr>
  `).join("");

  const mins = (typeof player.minutes === "number") ? player.minutes : 0;
  const role = player.role || "Rotation";

  // Personality / Traits display
  const traits = player.traits || {};
  function traitRow(label, key){
    const val = traits[key] ?? null;
    return `
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <div style="width:150px">${label}</div>
        <div style="flex:1">${val != null ? barHTML(val,99) : `<span class="muted">‚Äî</span>`}</div>
      </div>
    `;
  }

  function formatHistory(player){
    const h = (player.history || []).slice().sort((a,b)=>a.ts-b.ts);
    if (h.length === 0) return `<div class="muted">No history yet.</div>`;

    return h.map(e=>{
      const team = state.teams.find(t=>t.id===e.teamId);
      const tag = team ? team.abbrev : "‚Äî";
      const yr = e.seasonYear ?? "‚Äî";
      const ovr = (e.ovr ?? "‚Äî");
      const mins = (e.minutes != null) ? ` ‚Ä¢ Min ${e.minutes}` : "";
      return `
        <div style="padding:10px 0; border-bottom:1px solid rgba(255,255,255,.08);">
          <div><strong>${yr}</strong> <span class="muted">(${tag})</span> ‚Äî ${e.note || e.type || "Event"}</div>
          <div class="muted">OVR ${ovr}${mins}</div>
        </div>
      `;
    }).join("");
  }

  const historyHTML = formatHistory(player);

  pmBody.innerHTML = `
    <div class="row" style="gap:12px; margin-bottom:12px;">
      <div class="card" style="flex:1; box-shadow:none;">
        <div class="hd"><div class="title">Status</div></div>
        <div class="bd">
          <div>Role: <strong>${role}</strong></div>
          <div>Minutes: <strong>${mins}</strong></div>
          <div>Contract: <span class="muted">(later)</span></div>
          <div>Injury: <span class="muted">(later)</span></div>
        </div>
      </div>
      <div class="card" style="flex:1; box-shadow:none;">
        <div class="hd"><div class="title">Bio</div></div>
        <div class="bd">
          <div class="muted">Prototype bio</div>
          <div style="height:8px"></div>
          <div>${player.name} is a ${player.pos} for ${team.city}. (We‚Äôll add real bios later.)</div>
        </div>
      </div>
    </div>

    <div class="card" style="box-shadow:none; margin-bottom:12px;">
      <div class="hd"><div class="title">Personality</div></div>
      <div class="bd">
        ${traitRow('Competitiveness','competitiveness')}
        ${traitRow('Discipline','discipline')}
        ${traitRow('Work Ethic','workEthic')}
        ${traitRow('Ego','ego')}
        ${traitRow('Chemistry','chemistry')}
        ${traitRow('Mental Toughness','mental')}
      </div>
    </div>

    <div class="card" style="box-shadow:none; margin-bottom:12px;">
      <div class="hd"><div class="title">Scouting</div></div>
      <div class="bd">
        <div><strong>Strengths:</strong> ${strengths || '‚Äî'}</div>
        <div><strong>Weaknesses:</strong> ${weaknesses || '‚Äî'}</div>
      </div>
    </div>

    <div class="card" style="box-shadow:none;">
      <div class="hd"><div class="title">Ratings</div></div>
      <div class="bd" style="padding:0;">
        <table>
          <thead><tr><th>Skill</th><th class="right">Val</th><th>Bar</th></tr></thead>
          <tbody>${ratingRows || `<tr><td colspan="3" class="muted">No ratings found.</td></tr>`}</tbody>
        </table>
      </div>
    </div>

    <div class="card" style="box-shadow:none; margin-top:12px;">
      <div class="hd"><div class="title">History</div></div>
      <div class="bd">${historyHTML}</div>
    </div>
  `;

  const modal = document.getElementById("playerModal");
  if (!modal) return;
  modal.classList.remove("hide");
  modal.setAttribute("aria-hidden", "false");
}

function closePlayerModal(){
  const modal = document.getElementById("playerModal");
  if (!modal) return;
  modal.classList.add("hide");
  modal.setAttribute("aria-hidden", "true");
}

document.addEventListener("click", (e)=>{
  const btn = e.target.closest && e.target.closest("[data-player]");
  if (btn){ openPlayerModal(btn.dataset.player); return; }
});

const _pmClose = document.getElementById("pmClose");
if (_pmClose) _pmClose.addEventListener("click", closePlayerModal);
const _pmModal = document.getElementById("playerModal");
if (_pmModal){ _pmModal.addEventListener("click", (e)=>{ if (e.target && e.target.dataset && e.target.dataset.close) closePlayerModal(); }); }
</script>

</body>
</html>
