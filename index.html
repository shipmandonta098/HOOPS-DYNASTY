<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOOPS DYNASTY</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.085);
      --border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --bad:#fb7185;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 10% 10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 20%, rgba(167,139,250,.18), transparent 55%),
        radial-gradient(700px 600px at 40% 90%, rgba(52,211,153,.10), transparent 60%),
        var(--bg);
      min-height:100vh;
    }
    .hide{display:none !important;}

    /* buttons / inputs */
    .btn{
      cursor:pointer;border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 12px;border-radius:12px;
      transition:transform .06s ease, border-color .15s ease, background .15s ease;
      font-weight:700;font-size:13px;
    }
    .btn:hover{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.06);}
    .btn:active{transform:translateY(1px);}
    .btn.primary{border-color:rgba(110,231,255,.35);background:rgba(110,231,255,.10);}
    .btn.danger{border-color:rgba(251,113,133,.35);background:rgba(251,113,133,.10);}

    input, select{
      width:100%;
      padding:12px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(0,0,0,.18);color:var(--text);outline:none;
    }

    .muted{color:var(--muted);font-size:12px;}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    /* cards */
    .card{
      background:linear-gradient(to bottom, rgba(255,255,255,.07), rgba(255,255,255,.05));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hd{
      padding:12px 12px 10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .title{
      font-size:12px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);
    }
    .bd{padding:12px;}

    /* splash */
    .splash{
      position:fixed; inset:0;
      display:grid; place-items:center;
      background:
        radial-gradient(900px 450px at 50% 25%, rgba(110,231,255,.22), transparent 60%),
        radial-gradient(850px 550px at 50% 80%, rgba(167,139,250,.22), transparent 60%),
        var(--bg);
      z-index:50;
    }
    .splash-inner{ text-align:center; padding: 16px; }
    .splash-title{
      font-size:56px;
      font-weight:900;
      letter-spacing:.18em;
      margin:0;
      text-transform:uppercase;
    }
    .splash-sub{ margin: 12px 0 30px; color: rgba(255,255,255,.65); }
    .splash-btn{ width:min(520px, 92vw); padding:16px 18px; font-size:14px; }

    /* menus */
    .menu-wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 34px 16px;
      display:grid;
      gap: 14px;
    }

    /* app layout */
    .topbar{
      position:sticky; top:0; z-index:5;
      backdrop-filter:blur(10px);
      background:linear-gradient(to bottom, rgba(10,16,32,.82), rgba(10,16,32,.55));
      border-bottom:1px solid var(--border);
    }
    .topbar-inner{
      max-width:1200px;margin:0 auto;padding:14px 16px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
    }
    .brand{display:flex;gap:10px;align-items:center;}
    .logo{
      width:34px;height:34px;border-radius:12px;
      background:conic-gradient(from 210deg, var(--accent), var(--accent2), var(--good), var(--accent));
      box-shadow:var(--shadow);
    }
    h1{font-size:14px;margin:0;letter-spacing:.4px;}
    .pills{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
    .pill{
      font-size:12px;padding:6px 10px;border:1px solid var(--border);
      border-radius:999px;background:rgba(255,255,255,.04);color:var(--muted);
    }
    .wrap{
      max-width:1200px; margin: 0 auto; padding:16px;
      display:grid; grid-template-columns:320px 1fr; gap:14px;
    }
    @media (max-width:950px){ .wrap{grid-template-columns:1fr;} }

    .tabs{display:flex;gap:8px;flex-wrap:wrap;}
    .tab{
      cursor:pointer;padding:9px 10px;border-radius:12px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.04);
      font-size:12px;font-weight:750;color:var(--muted);user-select:none;
    }
    .tab.active{
      color:var(--text);
      border-color:rgba(110,231,255,.35);
      background:rgba(110,231,255,.10);
    }

    table{
      width:100%;border-collapse:collapse;
      overflow:hidden;border-radius:14px;border:1px solid rgba(255,255,255,.10);
    }
    th,td{
      padding:10px;border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;font-size:13px;
    }
    th{
      font-size:11px;text-transform:uppercase;letter-spacing:.12em;color:var(--muted);
      background:rgba(255,255,255,.03);
    }
    tr:last-child td{border-bottom:0;}
    .right{text-align:right;}

    /* Team picker table */
    #teamPickTable tbody tr { cursor: pointer; }
    #teamPickTable tbody tr:hover { background: rgba(255,255,255,.05); }
    #teamPickTable tbody tr.selected { background: rgba(110,231,255,.08); }

    /* Market size chips */
    .market-Large { color:#6ee7ff; font-weight:600; }
    .market-Medium{ color:#a78bfa; }
    .market-Small { color:#9ca3af; }

    /* Horizontal scroll container */
    .table-scroll{
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Prevent ugly column squish */
    #teamPickTable{ min-width: 720px; }

    /* Sticky first 3 columns */
    #teamPickTable th:nth-child(1),
    #teamPickTable td:nth-child(1){
      position: sticky; left: 0; background: rgba(10,16,32,.92); z-index: 2;
    }
    #teamPickTable th:nth-child(2),
    #teamPickTable td:nth-child(2){
      position: sticky; left: 50px; background: rgba(10,16,32,.92); z-index: 2;
    }
    #teamPickTable th:nth-child(3),
    #teamPickTable td:nth-child(3){
      position: sticky; left: 120px; background: rgba(10,16,32,.92); z-index: 2;
    }

    /* Make header sit above sticky cells */
    #teamPickTable thead th{ position: sticky; top: 0; z-index: 3; }

    /* Mobile: convert conf/division into a subline under team name */
    .team-subline{ display:none; }

    @media (max-width: 640px){
      /* Hide conf/div columns to reduce width */
      #teamPickTable th:nth-child(5),
      #teamPickTable td:nth-child(5),
      #teamPickTable th:nth-child(6),
      #teamPickTable td:nth-child(6){ display:none; }

      /* Show compact conf/div info under team name */
      .team-subline{ display:block; margin-top:4px; font-size:12px; color: rgba(255,255,255,.65); }

      /* Reduce min-width since we hid columns */
      #teamPickTable{ min-width: 520px; }

      /* Sticky offsets adjust slightly for smaller screens */
      #teamPickTable th:nth-child(2),
      #teamPickTable td:nth-child(2){ left: 44px; }
      #teamPickTable th:nth-child(3),
      #teamPickTable td:nth-child(3){ left: 110px; }
    }

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:3px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      font-size:11px;color:var(--muted);
      margin-left:8px;
    }
    .dot{width:8px;height:8px;border-radius:99px;background:var(--accent);box-shadow:0 0 0 3px rgba(110,231,255,.12);}

    .bar{
      height:8px;border-radius:999px;background:rgba(255,255,255,.10);
      overflow:hidden;border:1px solid rgba(255,255,255,.10);
    }
    .bar>i{
      display:block;height:100%;width:50%;
      background:linear-gradient(to right, var(--accent), var(--accent2));
    }

    .callout{
      padding:12px;border-radius:14px;
      border:1px solid rgba(110,231,255,.25);
      background:linear-gradient(to right, rgba(110,231,255,.12), rgba(167,139,250,.08));
    }

    .log{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      font-size:12px;line-height:1.35;white-space:pre-wrap;
      color:rgba(255,255,255,.78);
    }

    .big{font-size:18px;font-weight:900;letter-spacing:.2px;}
  </style>
</head>
<body>

<!-- 1) SPLASH -->
<div id="splashScreen" class="splash">
  <div class="splash-inner">
    <div class="logo" style="margin:0 auto 18px;" aria-hidden="true"></div>
    <div class="splash-title">HOOPS DYNASTY</div>
    <div class="splash-sub">Front office basketball simulation</div>
    <button class="btn primary splash-btn" id="btnEnterFO">Enter Front Office</button>
  </div>
</div>

<!-- 2) FRONT OFFICE MENU -->
<div id="frontOfficeScreen" class="menu-wrap hide">
  <div class="card">
    <div class="hd"><div class="title">Front Office</div></div>
    <div class="bd">
      <div class="row">
        <button class="btn primary" id="btnGoCreate">Create New League</button>
        <button class="btn" id="btnContinue">Continue</button>
        <button class="btn danger" id="btnWipeSave">Wipe Save</button>
      </div>
      <div class="muted" style="margin-top:10px;">
        Continue lights up when a saved league exists.
      </div>
    </div>
  </div>
</div>

<!-- 3) CREATE LEAGUE SCREEN -->
<div id="createLeagueScreen" class="menu-wrap hide">
  <div class="card">
    <div class="hd">
      <div class="title">Create League</div>
      <div class="muted" id="createHint">30 fictional teams • real U.S. cities</div>
    </div>
    <div class="bd">
      <div class="row">
        <div style="flex:1 1 320px;">
          <div class="muted">League Name</div>
          <div style="height:6px"></div>
          <input id="inpLeagueName" value="HOOPS DYNASTY" />
        </div>
        <div style="flex:1 1 220px;">
          <div class="muted">Season Year</div>
          <div style="height:6px"></div>
          <input id="inpSeasonYear" type="number" min="1900" max="2100" value="2026" />
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="muted">Select Your Team</div>
      <div style="height:10px"></div>

      <div class="card" style="box-shadow:none; background: rgba(255,255,255,.03);">
        <div class="bd" style="padding:0;">
          <div class="table-scroll">
            <table id="teamPickTable">
              <thead>
                <tr>
                  <th style="width:50px;">#</th>
                  <th style="width:70px;">Abbrev</th>
                  <th>Team</th>
                  <th style="width:90px;">Market</th>
                  <th style="width:90px;">Conf</th>
                  <th style="width:110px;">Division</th>
                </tr>
              </thead>
              <tbody id="teamPickBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="muted" style="margin-top:10px;">
        Selected: <strong id="pickedTeamLabel">—</strong>
      </div>

      <div style="height:14px"></div>

      <div class="row">
        <button class="btn" id="btnBackFO">Back</button>
        <button class="btn primary" id="btnCreateLeague">Create League</button>
      </div>
    </div>
  </div>
</div>

<!-- 4) APP -->
<div id="appScreen" class="hide">
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1 id="topTitle">HOOPS DYNASTY</h1>
          <div class="muted" id="topSub">—</div>
        </div>
      </div>
      <div class="pills">
        <span class="pill" id="pillSeason"></span>
        <span class="pill" id="pillDay"></span>
        <span class="pill" id="pillGamesLeft"></span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <!-- LEFT -->
    <div>
      <div class="card">
        <div class="hd"><div class="title">Controls</div></div>
        <div class="bd">
          <div class="row">
            <button class="btn" id="btnHome">Front Office</button>
            <button class="btn primary" id="btnNewLeagueQuick">New League (reroll)</button>
            <button class="btn" id="btnAdvanceDay">Advance Day</button>
            <button class="btn" id="btnSimGame">Sim Game</button>
          </div>

          <div style="height:12px"></div>

          <div class="muted">User Team</div>
          <div style="height:6px"></div>
          <select id="selUserTeam"></select>

          <div style="height:12px"></div>

          <div class="callout">
            <div class="muted">Next game</div>
            <div class="big" id="nextGameText">—</div>
            <div class="muted" id="nextGameSub">—</div>
          </div>

          <div style="height:12px"></div>

          <div class="muted">View</div>
          <div style="height:8px"></div>
          <div class="tabs" id="tabs">
            <div class="tab active" data-view="standings">Standings</div>
            <div class="tab" data-view="roster">Roster</div>
            <div class="tab" data-view="players">Players</div>
            <div class="tab" data-view="schedule">Schedule</div>
          </div>
        </div>
      </div>

      <div style="height:14px"></div>

      <div class="card">
        <div class="hd"><div class="title">Game Log</div></div>
        <div class="bd"><div id="log" class="log"></div></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="hd">
          <div class="title" id="viewTitle">Standings</div>
          <div class="muted" id="viewHint"></div>
        </div>
        <div class="bd" id="view"></div>
      </div>
    </div>
  </div>
</div>

<script>
/** =========================================================
 *  30 fictional teams (real U.S. cities)
 *  ========================================================= */
const TEAMS_30 = [
  {abbrev:"NYC", city:"New York",       name:"Empire",   market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"LAX", city:"Los Angeles",    name:"Stars",    market:"Large", conference:"West", division:"Pacific"},
  {abbrev:"CHI", city:"Chicago",        name:"Forge",    market:"Large", conference:"East", division:"Central"},
  {abbrev:"HOU", city:"Houston",        name:"Comets",   market:"Large", conference:"West", division:"Southwest"},
  {abbrev:"PHI", city:"Philadelphia",   name:"Liberty",  market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"PHX", city:"Phoenix",        name:"Inferno",  market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"SAS", city:"San Antonio",    name:"Outlaws",  market:"Medium",conference:"West", division:"Southwest"},
  {abbrev:"SDG", city:"San Diego",      name:"Tide",     market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"DAL", city:"Dallas",         name:"Stampede", market:"Large", conference:"West", division:"Southwest"},
  {abbrev:"SJC", city:"San Jose",       name:"Quakes",   market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"ATX", city:"Austin",         name:"Riders",   market:"Small", conference:"West", division:"Southwest"},
  {abbrev:"JAX", city:"Jacksonville",   name:"Duval",    market:"Small", conference:"East", division:"Southeast"},
  {abbrev:"SFW", city:"San Francisco",  name:"Gold",     market:"Large", conference:"West", division:"Pacific"},
  {abbrev:"CLB", city:"Columbus",       name:"Capitals", market:"Small", conference:"East", division:"Central"},
  {abbrev:"CLT", city:"Charlotte",      name:"Crown",    market:"Medium",conference:"East", division:"Southeast"},
  {abbrev:"IND", city:"Indianapolis",   name:"Shock",    market:"Small", conference:"East", division:"Central"},
  {abbrev:"SEA", city:"Seattle",        name:"Frost",    market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"DEN", city:"Denver",         name:"Altitude", market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"WAS", city:"Washington",     name:"Sentinels",market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"BOS", city:"Boston",         name:"Harbor",   market:"Large", conference:"East", division:"Atlantic"},
  {abbrev:"DET", city:"Detroit",        name:"Motors",   market:"Medium",conference:"East", division:"Central"},
  {abbrev:"NSH", city:"Nashville",      name:"Sound",    market:"Medium",conference:"West", division:"Southwest"},
  {abbrev:"POR", city:"Portland",       name:"Pulse",    market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"OKC", city:"Oklahoma City",  name:"Storm",    market:"Small", conference:"West", division:"Northwest"},
  {abbrev:"LAS", city:"Las Vegas",      name:"Neon",     market:"Medium",conference:"West", division:"Pacific"},
  {abbrev:"MIA", city:"Miami",          name:"Vice",     market:"Large", conference:"East", division:"Southeast"},
  {abbrev:"MSP", city:"Minneapolis",    name:"North",    market:"Medium",conference:"West", division:"Northwest"},
  {abbrev:"BWI", city:"Baltimore",      name:"Brigade",  market:"Small", conference:"East", division:"Atlantic"},
  {abbrev:"SLT", city:"Salt Lake City", name:"Summit",   market:"Small", conference:"West", division:"Northwest"},
  {abbrev:"ORL", city:"Orlando",        name:"Magicline",market:"Medium",conference:"East", division:"Southeast"},
];

/** =========================================================
 *  Simple name generator (you can expand later)
 *  ========================================================= */
const FIRST = ["Jasmine","Angelina","Myisha","Rhonda","Sofia","Tiana","Kira","Naomi","Avery","Layla","Marcus","Darius","Jalen","Trey","Andre","Caleb","Malik","Devin","Terrence","Isaiah","Jordan","Cameron","Noah","Miles","Xavier"];
const LAST  = ["Marks","Flor","Lewis","Gordon","Kafkis","Blake","Monroe","Stone","Knight","Rivers","Reed","Cole","Price","Morgan","Bishop","Knox","Cross","Shaw","Wynn","Hayes","Wells","Carter","Bennett","Brooks"];
const POS   = ["PG","SG","SF","PF","C"];

function rngInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }

function makeName(){
  const f = FIRST[rngInt(0, FIRST.length-1)];
  const l = LAST[rngInt(0, LAST.length-1)];
  const mid = String.fromCharCode(65 + rngInt(0,25)) + ".";
  return `${f} ${mid} ${l}`;
}

function calcOVR(p){
  return Math.round(
    (p.ratings.shooting * 0.28) +
    (p.ratings.finishing * 0.22) +
    (p.ratings.playmaking * 0.18) +
    (p.ratings.defense * 0.24) +
    (p.ratings.rebounding * 0.08)
  );
}

function makePlayer(){
  const base = rngInt(40, 75);
  const spread = () => clamp(base + rngInt(-10, 10), 25, 99);
  return {
    id: crypto.randomUUID(),
    name: makeName(),
    pos: POS[rngInt(0, POS.length-1)],
    age: rngInt(19,34),
    ratings: {
      shooting: spread(),
      finishing: spread(),
      playmaking: spread(),
      defense: spread(),
      rebounding: spread(),
    }
  };
}

function teamOVR(team){
  const top = [...team.players].map(calcOVR).sort((a,b)=>b-a).slice(0,8);
  const avg = top.reduce((s,n)=>s+n,0) / Math.max(1, top.length);
  return Math.round(avg);
}

function gameScore(teamA, teamB){
  const ovrA = teamOVR(teamA);
  const ovrB = teamOVR(teamB);
  const base = 95;
  const a = Math.round(base + (ovrA - 60) * 1.2 + rngInt(-18, 18));
  const b = Math.round(base + (ovrB - 60) * 1.2 + rngInt(-18, 18));
  return { a: Math.max(65,a), b: Math.max(65,b) };
}

function barHTML(value, max=100){
  const w = clamp(Math.round((value/max)*100), 0, 100);
  return `<div class="bar" title="${value}"><i style="width:${w}%"></i></div>`;
}

function pct(t){ const g=t.wins+t.losses; return g ? (t.wins/g) : 0; }

/** =========================================================
 *  Save/Load (localStorage)
 *  ========================================================= */
const SAVE_KEY = "hoopsDynastySave_v02";

function hasSave(){ return !!localStorage.getItem(SAVE_KEY); }

function saveLeague(){
  localStorage.setItem(SAVE_KEY, JSON.stringify(state));
  updateFOButtons();
}

function loadLeague(){
  const raw = localStorage.getItem(SAVE_KEY);
  if (!raw) return false;
  try{
    state = JSON.parse(raw);
    return true;
  }catch(e){
    console.warn("Save corrupted", e);
    return false;
  }
}

function wipeSave(){
  localStorage.removeItem(SAVE_KEY);
  updateFOButtons();
}

function updateFOButtons(){
  const c = document.getElementById("btnContinue");
  const w = document.getElementById("btnWipeSave");
  if (!c || !w) return;
  const ok = hasSave();
  c.disabled = !ok;
  w.disabled = !ok;
}

function renderTeamPickTable(){
  const body = document.getElementById("teamPickBody");
  const label = document.getElementById("pickedTeamLabel");
  if (!body || !label) return;

  body.innerHTML = "";

  TEAMS_30.forEach((t, idx) => {
    const tr = document.createElement("tr");
    tr.dataset.abbrev = t.abbrev;
    if (t.abbrev === selectedCreateTeamAbbrev) tr.classList.add("selected");

    tr.innerHTML = `
      <td>${idx + 1}</td>
      <td><strong>${t.abbrev}</strong></td>
      <td>
        <strong>${t.city} ${t.name}</strong>
        <div class="team-subline">${t.conference} • ${t.division}</div>
      </td>
      <td class="market-${t.market}">${t.market}</td>
      <td class="muted">${t.conference}</td>
      <td class="muted">${t.division}</td>
    `;

    tr.addEventListener("click", () => {
      selectedCreateTeamAbbrev = t.abbrev;
      renderTeamPickTable();
    });

    body.appendChild(tr);
  });

  const picked = TEAMS_30.find(x => x.abbrev === selectedCreateTeamAbbrev) || TEAMS_30[0];
  label.textContent = `${picked.abbrev} — ${picked.city} ${picked.name}`;
}

/** =========================================================
 *  App state
 *  ========================================================= */
let state = {
  leagueName: "HOOPS DYNASTY",
  seasonYear: 2026,
  seasonNumber: 1,
  day: 1,
  view: "standings",
  userTeamId: null,
  teams: [],
  schedule: [],
  log: [],
};

let selectedCreateTeamAbbrev = "POR";

function logLine(msg){
  state.log.unshift(`[Day ${state.day}] ${msg}`);
  state.log = state.log.slice(0, 14);
  const el = document.getElementById("log");
  if (el) el.textContent = state.log.join("\n");
}

function buildTeamsFromTemplate(){
  return TEAMS_30.map(t => ({
    id: crypto.randomUUID(),
    abbrev: t.abbrev,
    city: t.city,
    nickname: t.name,
    name: `${t.city} ${t.name}`,
    wins: 0,
    losses: 0,
    players: [],
  }));
}

function generateSchedule(teamIds, games = 300){
  // Simple: random games across season days. You can replace with proper NBA scheduling later.
  const sched = [];
  let day = 1;
  for (let i=0;i<games;i++){
    const home = teamIds[rngInt(0, teamIds.length-1)];
    let away = teamIds[rngInt(0, teamIds.length-1)];
    while (away === home) away = teamIds[rngInt(0, teamIds.length-1)];
    sched.push({ day, homeId: home, awayId: away, played:false, homeScore:null, awayScore:null });
    day++;
  }
  return sched;
}

function createLeague({leagueName, seasonYear, userTeamAbbrev}){
  state.leagueName = leagueName;
  state.seasonYear = seasonYear;
  state.seasonNumber = 1;
  state.day = 1;
  state.view = "standings";
  state.log = [];

  state.teams = buildTeamsFromTemplate();

  // Fill rosters
  for (const team of state.teams){
    team.wins = 0; team.losses = 0; team.players = [];
    for (let i=0;i<10;i++) team.players.push(makePlayer());
  }

  // Set user team by abbrev
  const userTeam = state.teams.find(t => t.abbrev === userTeamAbbrev) || state.teams[0];
  state.userTeamId = userTeam.id;

  state.schedule = generateSchedule(state.teams.map(t=>t.id), 360); // ~360 days/games (toy)

  logLine(`League created: ${state.leagueName} (${state.seasonYear})`);
  saveLeague();
  renderAll();
}

/** =========================================================
 *  Sim actions
 *  ========================================================= */
function gamesLeft(){ return state.schedule.filter(g=>!g.played).length; }

function nextGameForUser(){
  const uid = state.userTeamId;
  return state.schedule.find(g => !g.played && (g.homeId===uid || g.awayId===uid));
}

function simSpecificGame(game){
  const home = state.teams.find(t=>t.id===game.homeId);
  const away = state.teams.find(t=>t.id===game.awayId);
  const s = gameScore(home, away);

  game.played = true;
  game.homeScore = s.a;
  game.awayScore = s.b;

  if (s.a > s.b){ home.wins++; away.losses++; }
  else { away.wins++; home.losses++; }

  logLine(`${away.abbrev} ${s.b} @ ${home.abbrev} ${s.a}`);
}

function advanceDay(){
  const todays = state.schedule.filter(g => g.day === state.day && !g.played);
  for (const g of todays) simSpecificGame(g);

  const next = state.schedule.find(g=>!g.played);
  if (!next) logLine("Season complete. (Prototype stops here.)");
  else state.day = Math.max(state.day + 1, next.day);

  saveLeague();
  renderAll();
}

function simOneGame(){
  const g = state.schedule.find(g=>!g.played);
  if (!g){ logLine("No games left."); renderAll(); return; }
  state.day = Math.max(state.day, g.day);
  simSpecificGame(g);
  saveLeague();
  renderAll();
}

/** =========================================================
 *  Rendering
 *  ========================================================= */
function showScreen(name){
  document.getElementById("splashScreen").classList.add("hide");
  document.getElementById("frontOfficeScreen").classList.add("hide");
  document.getElementById("createLeagueScreen").classList.add("hide");
  document.getElementById("appScreen").classList.add("hide");

  if (name==="splash") document.getElementById("splashScreen").classList.remove("hide");
  if (name==="frontOffice") document.getElementById("frontOfficeScreen").classList.remove("hide");
  if (name==="createLeague") document.getElementById("createLeagueScreen").classList.remove("hide");
  if (name==="app") document.getElementById("appScreen").classList.remove("hide");
}

function renderTop(){
  document.getElementById("topTitle").textContent = `${state.leagueName}`;
  document.getElementById("topSub").textContent = `Season Year: ${state.seasonYear}`;
  document.getElementById("pillSeason").textContent = `Season ${state.seasonNumber}`;
  document.getElementById("pillDay").textContent = `Day ${state.day}`;
  document.getElementById("pillGamesLeft").textContent = `${gamesLeft()} games left`;
}

function renderTeamSelectApp(){
  const sel = document.getElementById("selUserTeam");
  sel.innerHTML = "";
  for (const t of state.teams){
    const opt = document.createElement("option");
    opt.value = t.id;
    opt.textContent = `${t.abbrev} — ${t.name}`;
    sel.appendChild(opt);
  }
  sel.value = state.userTeamId;
}

function renderNextGame(){
  const g = nextGameForUser();
  const big = document.getElementById("nextGameText");
  const sub = document.getElementById("nextGameSub");
  if (!g){ big.textContent="No remaining games"; sub.textContent="Schedule is cooked. (End Season comes next.)"; return; }
  const home = state.teams.find(t=>t.id===g.homeId);
  const away = state.teams.find(t=>t.id===g.awayId);
  big.textContent = `${away.abbrev} @ ${home.abbrev}`;
  sub.textContent = `Day ${g.day} • ${away.name} vs ${home.name}`;
}

function renderStandings(){
  const uid = state.userTeamId;
  const teams = [...state.teams].sort((a,b)=>{
    const da = (b.wins - b.losses) - (a.wins - a.losses);
    return da !== 0 ? da : (teamOVR(b) - teamOVR(a));
  });

  const rows = teams.map(t=>{
    const isUser = t.id===uid;
    const ovr = teamOVR(t);
    const pctStr = (pct(t)*100).toFixed(1) + "%";
    return `
      <tr style="${isUser ? 'background: rgba(110,231,255,.06);' : ''}">
        <td>
          <strong>${t.abbrev}</strong> <span class="muted">(${t.name})</span>
          ${isUser ? `<span class="badge"><span class="dot"></span>YOUR TEAM</span>` : ``}
        </td>
        <td class="right">${t.wins}</td>
        <td class="right">${t.losses}</td>
        <td class="right">${pctStr}</td>
        <td style="width:180px">${barHTML(ovr, 99)}</td>
        <td class="right">${ovr}</td>
      </tr>
    `;
  }).join("");

  document.getElementById("viewHint").textContent = "Win% + power bar (toy OVR)";
  return `
    <table>
      <thead>
        <tr><th>Team</th><th class="right">W</th><th class="right">L</th><th class="right">Win%</th><th>Power</th><th class="right">OVR</th></tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderRoster(){
  const team = state.teams.find(t=>t.id===state.userTeamId);
  const players = [...team.players].map(p=>({ ...p, ovr: calcOVR(p) })).sort((a,b)=>b.ovr-a.ovr);
  document.getElementById("viewHint").textContent = "Your roster (ratings only for now)";
  const rows = players.map(p=>`
    <tr>
      <td><strong>${p.name}</strong><div class="muted">${p.pos} • Age ${p.age}</div></td>
      <td class="right"><strong>${p.ovr}</strong></td>
      <td style="width:120px">${barHTML(p.ratings.shooting)}</td>
      <td style="width:120px">${barHTML(p.ratings.finishing)}</td>
      <td style="width:120px">${barHTML(p.ratings.playmaking)}</td>
      <td style="width:120px">${barHTML(p.ratings.defense)}</td>
      <td style="width:120px">${barHTML(p.ratings.rebounding)}</td>
    </tr>
  `).join("");

  return `
    <div class="callout" style="margin-bottom:12px;">
      <div class="muted">Team</div>
      <div class="big">${team.abbrev} — ${team.name}</div>
      <div class="muted">Record: ${team.wins}-${team.losses} • Team OVR: ${teamOVR(team)}</div>
    </div>

    <table>
      <thead><tr><th>Player</th><th class="right">OVR</th><th>SHO</th><th>FIN</th><th>PLY</th><th>DEF</th><th>REB</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderPlayers(){
  const all = state.teams.flatMap(t=> t.players.map(p=>({
    team: t.abbrev,
    name: p.name,
    pos: p.pos,
    age: p.age,
    ovr: calcOVR(p),
  }))).sort((a,b)=>b.ovr-a.ovr);

  document.getElementById("viewHint").textContent = "All players (sorted by OVR)";
  const rows = all.map(p=>`
    <tr>
      <td><strong>${p.name}</strong><div class="muted">${p.team} • ${p.pos} • Age ${p.age}</div></td>
      <td class="right">${p.ovr}</td>
      <td style="width:220px">${barHTML(p.ovr, 99)}</td>
    </tr>
  `).join("");

  return `
    <table>
      <thead><tr><th>Player</th><th class="right">OVR</th><th>Bar</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderSchedule(){
  document.getElementById("viewHint").textContent = "Schedule (your games highlighted)";
  const rows = state.schedule.slice(0, 120).map(g=>{
    const home = state.teams.find(t=>t.id===g.homeId);
    const away = state.teams.find(t=>t.id===g.awayId);
    const isUser = (g.homeId===state.userTeamId || g.awayId===state.userTeamId);
    const line = g.played ? `${away.abbrev} ${g.awayScore} @ ${home.abbrev} ${g.homeScore}` : `${away.abbrev} @ ${home.abbrev}`;
    return `
      <tr style="${isUser ? 'background: rgba(110,231,255,.06);' : ''}">
        <td>Day ${g.day}</td>
        <td>${line} ${isUser ? `<span class="badge"><span class="dot"></span>YOUR GAME</span>` : ``}</td>
        <td class="right">${g.played ? "Final" : "Scheduled"}</td>
      </tr>
    `;
  }).join("");

  return `
    <div class="muted" style="margin-bottom:10px;">Showing first 120 games (we’ll add filters later).</div>
    <table>
      <thead><tr><th>Day</th><th>Matchup</th><th class="right">Status</th></tr></thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

function renderView(){
  const title = document.getElementById("viewTitle");
  const el = document.getElementById("view");
  if (state.view==="standings"){ title.textContent="Standings"; el.innerHTML = renderStandings(); }
  if (state.view==="roster"){ title.textContent="Roster"; el.innerHTML = renderRoster(); }
  if (state.view==="players"){ title.textContent="Players"; el.innerHTML = renderPlayers(); }
  if (state.view==="schedule"){ title.textContent="Schedule"; el.innerHTML = renderSchedule(); }
}

function renderAll(){
  renderTop();
  renderTeamSelectApp();
  renderNextGame();
  renderView();
  document.getElementById("log").textContent = state.log.join("\n");
}

/** =========================================================
 *  Create-league screen setup
 *  ========================================================= */
function populateCreateTeamSelect(){
  const sel = document.getElementById("selCreateTeam");
  sel.innerHTML = "";
  for (const t of TEAMS_30){
    const opt = document.createElement("option");
    opt.value = t.abbrev;
    opt.textContent = `${t.abbrev} — ${t.city} ${t.name}`;
    sel.appendChild(opt);
  }
  sel.value = "POR"; // default
}

/** =========================================================
 *  UI wiring
 *  ========================================================= */
document.getElementById("btnEnterFO").addEventListener("click", ()=>{
  updateFOButtons();
  showScreen("frontOffice");
});

document.getElementById("btnGoCreate").addEventListener("click", ()=>{
  selectedCreateTeamAbbrev = "POR";
  renderTeamPickTable();
  showScreen("createLeague");
});

document.getElementById("btnBackFO").addEventListener("click", ()=>{
  updateFOButtons();
  showScreen("frontOffice");
});

document.getElementById("btnCreateLeague").addEventListener("click", ()=>{
  const leagueName = (document.getElementById("inpLeagueName").value || "HOOPS DYNASTY").trim();
  const seasonYear = parseInt(document.getElementById("inpSeasonYear").value, 10) || 2026;
  const userTeamAbbrev = selectedCreateTeamAbbrev;

  createLeague({ leagueName, seasonYear, userTeamAbbrev });
  showScreen("app");
});

document.getElementById("btnContinue").addEventListener("click", ()=>{
  if (loadLeague()){
    renderAll();
    showScreen("app");
  }
});

document.getElementById("btnWipeSave").addEventListener("click", wipeSave);

document.getElementById("btnHome").addEventListener("click", ()=>{
  updateFOButtons();
  showScreen("frontOffice");
});

document.getElementById("btnNewLeagueQuick").addEventListener("click", ()=>{
  // reroll with same league name/year/user team abbrev (best effort)
  const userTeam = state.teams.find(t=>t.id===state.userTeamId);
  const abbrev = userTeam ? userTeam.abbrev : "POR";
  createLeague({ leagueName: state.leagueName, seasonYear: state.seasonYear, userTeamAbbrev: abbrev });
});

document.getElementById("btnAdvanceDay").addEventListener("click", advanceDay);
document.getElementById("btnSimGame").addEventListener("click", simOneGame);

document.getElementById("selUserTeam").addEventListener("change", (e)=>{
  state.userTeamId = e.target.value;
  saveLeague();
  renderAll();
});

document.getElementById("tabs").addEventListener("click", (e)=>{
  const tab = e.target.closest(".tab");
  if (!tab) return;
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  tab.classList.add("active");
  state.view = tab.dataset.view;
  saveLeague();
  renderView();
});

// boot
updateFOButtons();
populateCreateTeamSelect();
showScreen("splash");
</script>

</body>
</html>
